@using Famick.HomeManagement.Core.DTOs.Stock
@using Famick.HomeManagement.UI.Services
@inject IApiClient ApiClient
@inject ILocalizer L

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.History" />
            <MudText Typo="Typo.h6">@L["stock.journal"]</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }
        else if (_logs.Count == 0)
        {
            <MudAlert Severity="Severity.Info">@L["stock.noJournalEntries"]</MudAlert>
        }
        else
        {
            <MudTable Items="@_logs" Dense="true" Hover="true" Striped="true">
                <HeaderContent>
                    <MudTh>@L["stock.journalDate"]</MudTh>
                    <MudTh>@L["stock.journalProduct"]</MudTh>
                    <MudTh>@L["stock.journalType"]</MudTh>
                    <MudTh Style="text-align: right">@L["stock.journalAmount"]</MudTh>
                    <MudTh>@L["stock.journalLocation"]</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="@L["stock.journalDate"]">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.body2">@context.CreatedAt.ToString("yyyy-MM-dd")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@context.CreatedAt.ToString("HH:mm")</MudText>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="@L["stock.journalProduct"]">@context.ProductName</MudTd>
                    <MudTd DataLabel="@L["stock.journalType"]">
                        <MudChip T="string" Size="Size.Small" Color="@GetTransactionColor(context.TransactionType)"
                                 Variant="Variant.Outlined">
                            @GetTransactionLabel(context.TransactionType)
                        </MudChip>
                        @if (context.Spoiled)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Filled">
                                @L["stock.spoiled"]
                            </MudChip>
                        }
                    </MudTd>
                    <MudTd DataLabel="@L["stock.journalAmount"]" Style="text-align: right">
                        <MudText Color="@(context.Amount >= 0 ? Color.Success : Color.Error)">
                            @(context.Amount >= 0 ? "+" : "")@context.Amount.ToString("0.##")
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="@L["stock.journalLocation"]">
                        @(context.LocationName ?? "-")
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">@L["common.close"]</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; } = null!;

    private List<StockLogDto> _logs = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadLogsAsync();
    }

    private async Task LoadLogsAsync()
    {
        _isLoading = true;
        try
        {
            var result = await ApiClient.GetAsync<List<StockLogDto>>("api/v1/stock/log?limit=100");
            if (result.IsSuccess && result.Data != null)
            {
                _logs = result.Data;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading stock log: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void Close() => MudDialog.Close();

    private Color GetTransactionColor(string transactionType)
    {
        return transactionType switch
        {
            "purchase" => Color.Success,
            "consume" => Color.Error,
            "inventory-correction" => Color.Warning,
            "product-opened" => Color.Info,
            "stock-edit-new" or "stock-edit-old" => Color.Default,
            _ => Color.Default
        };
    }

    private string GetTransactionLabel(string transactionType)
    {
        return transactionType switch
        {
            "purchase" => L["stock.txPurchase"],
            "consume" => L["stock.txConsume"],
            "inventory-correction" => L["stock.txCorrection"],
            "product-opened" => L["stock.txOpened"],
            "stock-edit-new" => L["stock.txEditNew"],
            "stock-edit-old" => L["stock.txEditOld"],
            _ => transactionType
        };
    }
}
