@using Famick.HomeManagement.Core.DTOs.Stock
@using Famick.HomeManagement.Core.DTOs.Products
@inject ILocalizer L

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">@L["inventory.addStock"]</MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            @* Product info *@
            <MudText Typo="Typo.subtitle1" Class="font-weight-medium">
                @Product.Name
            </MudText>

            @* Quantity *@
            <MudNumericField T="decimal" @bind-Value="_amount"
                             Label="@L["inventory.quantity"]"
                             Variant="Variant.Outlined"
                             Min="0.01m"
                             Step="1m"
                             Required="true"
                             Adornment="Adornment.End"
                             AdornmentText="@_quantityUnitName" />

            @* Best before date *@
            <MudDatePicker @bind-Date="_bestBeforeDate"
                           Label="@L["inventory.bestBefore"]"
                           Variant="Variant.Outlined"
                           Editable="true"
                           Clearable="true"
                           MinDate="DateTime.Today" />

            @* Price (optional) *@
            <MudNumericField T="decimal?" @bind-Value="_price"
                             Label="@L["inventory.price"]"
                             Variant="Variant.Outlined"
                             Min="0m"
                             Step="0.01m"
                             Adornment="Adornment.Start"
                             AdornmentText="$" />

            @* Note (optional) *@
            <MudTextField @bind-Value="_note"
                          Label="@L["inventory.note"]"
                          Variant="Variant.Outlined"
                          Lines="2" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@L["common.cancel"]</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled"
                   Disabled="@(_amount <= 0)"
                   OnClick="Submit">
            @L["inventory.addStock"]
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public ProductDto Product { get; set; } = null!;

    [Parameter]
    public Guid LocationId { get; set; }

    private decimal _amount = 1;
    private DateTime? _bestBeforeDate;
    private decimal? _price;
    private string? _note;
    private string _quantityUnitName = string.Empty;

    protected override void OnInitialized()
    {
        _quantityUnitName = Product.QuantityUnitStockName ?? string.Empty;

        // Set default best before date if product has DefaultBestBeforeDays
        if (Product.DefaultBestBeforeDays > 0)
        {
            _bestBeforeDate = DateTime.Today.AddDays(Product.DefaultBestBeforeDays);
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private void Submit()
    {
        var request = new AddStockRequest
        {
            ProductId = Product.Id,
            Amount = _amount,
            BestBeforeDate = _bestBeforeDate?.ToUniversalTime(),
            PurchasedDate = DateTime.UtcNow,
            Price = _price,
            LocationId = LocationId,
            Note = _note
        };

        MudDialog.Close(DialogResult.Ok(request));
    }
}
