@using Famick.HomeManagement.Core.DTOs.Equipment
@inject ILocalizer L

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">@L["equipment.usage.addReading"]</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form">
            <MudStack Spacing="3">
                <MudDatePicker @bind-Date="_date"
                               Label="@L["equipment.usage.date"]"
                               Variant="Variant.Outlined"
                               Required="true"
                               RequiredError="@L["validation.required"]"
                               Editable="true" />

                <MudNumericField T="decimal" @bind-Value="_reading"
                                 Label="@L["equipment.usage.reading"]"
                                 Variant="Variant.Outlined"
                                 Min="0m"
                                 Step="1m"
                                 Required="true"
                                 RequiredError="@L["validation.required"]"
                                 Adornment="Adornment.End"
                                 AdornmentText="@UsageUnit" />

                <MudTextField @bind-Value="_notes"
                              Label="@L["equipment.usage.notes"]"
                              Variant="Variant.Outlined"
                              Lines="2" />
            </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@L["common.cancel"]</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled"
                   Disabled="@(_date == null)"
                   OnClick="Submit">
            @L["common.save"]
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public string UsageUnit { get; set; } = string.Empty;

    [Parameter]
    public decimal? LastReading { get; set; }

    private MudForm _form = null!;
    private DateTime? _date = DateTime.Today;
    private decimal _reading;
    private string? _notes;

    protected override void OnInitialized()
    {
        // Default to slightly higher than last reading if available
        if (LastReading.HasValue)
        {
            _reading = LastReading.Value;
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private void Submit()
    {
        var request = new CreateEquipmentUsageLogRequest
        {
            Date = _date!.Value,
            Reading = _reading,
            Notes = _notes
        };

        MudDialog.Close(DialogResult.Ok(request));
    }
}
