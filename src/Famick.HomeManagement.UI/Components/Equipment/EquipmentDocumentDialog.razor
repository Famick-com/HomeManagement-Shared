@using Famick.HomeManagement.Core.DTOs.Equipment
@inject ILocalizer L

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            @if (IsEditMode)
            {
                @L["equipment.documents.editDocument"]
            }
            else
            {
                @L["equipment.documents.uploadDocument"]
            }
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            @if (!IsEditMode && !string.IsNullOrEmpty(FileName))
            {
                <MudAlert Severity="Severity.Info" Dense="true">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.AttachFile" Size="Size.Small" />
                        <MudText Typo="Typo.body2">@FileName</MudText>
                        @if (FileSize > 0)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">(@FormatFileSize(FileSize))</MudText>
                        }
                    </MudStack>
                </MudAlert>
            }

            <MudTextField @bind-Value="_displayName"
                          Label="@L["equipment.documents.displayName"]"
                          Placeholder="@(FileName ?? L["equipment.documents.displayNamePlaceholder"])"
                          Variant="Variant.Outlined"
                          HelperText="@L["equipment.documents.displayNameHelper"]" />

            <MudSelect T="Guid?"
                       @bind-Value="_selectedTagId"
                       Label="@L["equipment.documents.tag"]"
                       Variant="Variant.Outlined"
                       Clearable="true"
                       AnchorOrigin="Origin.BottomCenter">
                @foreach (var tag in Tags)
                {
                    <MudSelectItem T="Guid?" Value="@tag.Id">@tag.Name</MudSelectItem>
                }
            </MudSelect>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@L["common.cancel"]</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="Submit"
                   Disabled="@_isSubmitting">
            @if (_isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            @if (IsEditMode)
            {
                @L["common.save"]
            }
            else
            {
                @L["equipment.documents.upload"]
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; } = null!;

    /// <summary>
    /// True for edit mode, false for upload mode
    /// </summary>
    [Parameter]
    public bool IsEditMode { get; set; }

    /// <summary>
    /// File name (for upload mode display)
    /// </summary>
    [Parameter]
    public string? FileName { get; set; }

    /// <summary>
    /// File size in bytes (for upload mode display)
    /// </summary>
    [Parameter]
    public long FileSize { get; set; }

    /// <summary>
    /// Available document tags
    /// </summary>
    [Parameter]
    public List<EquipmentDocumentTagDto> Tags { get; set; } = new();

    /// <summary>
    /// Initial display name (for edit mode)
    /// </summary>
    [Parameter]
    public string? InitialDisplayName { get; set; }

    /// <summary>
    /// Initial tag ID (for edit mode)
    /// </summary>
    [Parameter]
    public Guid? InitialTagId { get; set; }

    private string? _displayName;
    private Guid? _selectedTagId;
    private bool _isSubmitting;

    protected override void OnInitialized()
    {
        _displayName = InitialDisplayName;
        _selectedTagId = InitialTagId;
    }

    private void Cancel() => MudDialog.Cancel();

    private void Submit()
    {
        _isSubmitting = true;
        var result = new EquipmentDocumentDialogResult
        {
            DisplayName = string.IsNullOrWhiteSpace(_displayName) ? null : _displayName.Trim(),
            TagId = _selectedTagId
        };
        MudDialog.Close(DialogResult.Ok(result));
    }

    private static string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    public class EquipmentDocumentDialogResult
    {
        public string? DisplayName { get; set; }
        public Guid? TagId { get; set; }
    }
}
