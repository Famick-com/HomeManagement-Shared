@using Famick.HomeManagement.Core.DTOs.ShoppingLists
@inject ILocalizer L

<MudPaper Elevation="0"
          Class="@($"pa-3 mb-2 {(Item.IsPurchased ? "purchased-item" : "")} {(Item.IsParentProduct ? "parent-product-item" : "")}")"
          Style="@GetItemStyle()"
          @onclick="@HandleItemClick">
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
        <MudTooltip Text="@(CanEdit ? null : L["common.viewerNoPermission"])" Disabled="@CanEdit">
            <MudCheckBox T="bool"
                         Value="@Item.IsPurchased"
                         ValueChanged="@OnCheckedChanged"
                         Color="Color.Success"
                         Disabled="@(!CanEdit || IsLoading)"
                         Size="Size.Medium"
                         @onclick:stopPropagation="true" />
        </MudTooltip>

        <MudStack Spacing="0" Class="flex-grow-1">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudText Typo="Typo.body1"
                         Style="@(Item.IsPurchased ? "text-decoration: line-through; color: var(--mud-palette-text-secondary);" : "font-weight: 500;")">
                    @(Item.ProductName ?? "Unknown Product")
                </MudText>

                @* Parent product indicator *@
                @if (Item.IsParentProduct)
                {
                    @if (!Item.HasChildrenAtStore)
                    {
                        <MudTooltip Text="@L["shopping.childProducts.noChildrenAtStoreWarning"]">
                            <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Size="Size.Small" />
                        </MudTooltip>
                    }
                }
            </MudStack>

            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                @if (Item.Amount > 0 && !string.IsNullOrEmpty(Item.QuantityUnitName))
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @Item.Amount @Item.QuantityUnitName
                    </MudText>
                }
                else if (Item.Amount > 0)
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        x@Item.Amount
                    </MudText>
                }

                @* Child purchase progress for parent products *@
                @if (Item.IsParentProduct && Item.ChildPurchasedQuantity > 0)
                {
                    <MudChip T="string" Size="Size.Small"
                             Color="@(Item.ChildPurchasedQuantity >= Item.Amount ? Color.Success : Color.Info)"
                             Variant="Variant.Filled">
                        @Item.ChildPurchasedQuantity / @Item.Amount @L["shopping.childProducts.checkedOff"]
                    </MudChip>
                }

                @* Scan purchase progress for non-parent products *@
                @if (!Item.IsParentProduct && Item.PurchasedQuantity > 0 && Item.Amount > 1)
                {
                    <MudChip T="string" Size="Size.Small"
                             Color="@(Item.PurchasedQuantity >= Item.Amount ? Color.Success : Color.Info)"
                             Variant="Variant.Filled">
                        @Item.PurchasedQuantity / @Item.Amount @L["shopping.scanned"]
                    </MudChip>
                }

                @if (Item.Price.HasValue)
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        $@Item.Price.Value.ToString("F2")
                    </MudText>
                }
            </MudStack>

            @if (!string.IsNullOrEmpty(Item.Note))
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                    @Item.Note
                </MudText>
            }
        </MudStack>

        @if (!string.IsNullOrEmpty(Item.ImageUrl))
        {
            <MudAvatar Size="Size.Medium" Rounded="true">
                <MudImage Src="@Item.ImageUrl" Alt="@Item.ProductName" />
            </MudAvatar>
        }

        @* Expand chevron for parent products *@
        @if (Item.IsParentProduct)
        {
            <MudIcon Icon="@Icons.Material.Filled.ChevronRight"
                     Color="Color.Primary"
                     Size="Size.Medium" />
        }
    </MudStack>
</MudPaper>

@code {
    [Parameter, EditorRequired]
    public ShoppingListItemDto Item { get; set; } = null!;

    [Parameter]
    public bool CanEdit { get; set; } = true;

    [Parameter]
    public bool IsLoading { get; set; }

    [Parameter]
    public EventCallback<bool> OnPurchasedChanged { get; set; }

    [Parameter]
    public EventCallback<ShoppingListItemDto> OnParentItemClicked { get; set; }

    private string GetItemStyle()
    {
        var styles = new List<string>();

        if (Item.IsPurchased)
        {
            styles.Add("background-color: var(--mud-palette-background-grey)");
            styles.Add("opacity: 0.7");
        }

        if (Item.IsParentProduct)
        {
            styles.Add("cursor: pointer");
            if (!Item.IsPurchased)
            {
                styles.Add("border-left: 3px solid var(--mud-palette-primary)");
            }
        }

        return string.Join("; ", styles);
    }

    private async Task OnCheckedChanged(bool newValue)
    {
        await OnPurchasedChanged.InvokeAsync(newValue);
    }

    private async Task HandleItemClick()
    {
        if (Item.IsParentProduct && OnParentItemClicked.HasDelegate)
        {
            await OnParentItemClicked.InvokeAsync(Item);
        }
    }
}
