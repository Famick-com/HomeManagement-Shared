@inject ILocalizer L
@using Famick.HomeManagement.Core.DTOs.Common

<MudDialog @bind-Visible="Visible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">@L["address.confirmTitle"]</MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid Spacing="3">
            @* Original Input *@
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-3" Elevation="1">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">@L["address.yourInput"]</MudText>
                    <MudStack Spacing="0">
                        @if (!string.IsNullOrWhiteSpace(OriginalAddress?.AddressLine1))
                        {
                            <MudText>@OriginalAddress.AddressLine1</MudText>
                        }
                        @if (!string.IsNullOrWhiteSpace(OriginalAddress?.AddressLine2))
                        {
                            <MudText>@OriginalAddress.AddressLine2</MudText>
                        }
                        @{
                            var originalCityStateZip = BuildCityStateZip(OriginalAddress);
                        }
                        @if (!string.IsNullOrWhiteSpace(originalCityStateZip))
                        {
                            <MudText>@originalCityStateZip</MudText>
                        }
                        @if (!string.IsNullOrWhiteSpace(OriginalAddress?.Country))
                        {
                            <MudText>@OriginalAddress.Country</MudText>
                        }
                    </MudStack>
                </MudPaper>
            </MudItem>

            @* Normalized Address *@
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-3" Elevation="1" Style="background-color: var(--mud-palette-success-lighten);">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">@L["address.normalized"]</MudText>
                    @if (NormalizedAddress != null)
                    {
                        <MudStack Spacing="0">
                            @if (!string.IsNullOrWhiteSpace(NormalizedAddress.AddressLine1))
                            {
                                <MudText><b>@NormalizedAddress.AddressLine1</b></MudText>
                            }
                            @if (!string.IsNullOrWhiteSpace(NormalizedAddress.AddressLine2))
                            {
                                <MudText>@NormalizedAddress.AddressLine2</MudText>
                            }
                            @{
                                var normalizedCityStateZip = BuildCityStateZipFromResult(NormalizedAddress);
                            }
                            @if (!string.IsNullOrWhiteSpace(normalizedCityStateZip))
                            {
                                <MudText>@normalizedCityStateZip</MudText>
                            }
                            @if (!string.IsNullOrWhiteSpace(NormalizedAddress.Country))
                            {
                                <MudText>@NormalizedAddress.Country</MudText>
                            }
                        </MudStack>

                        @if (NormalizedAddress.Confidence < 0.8)
                        {
                            <MudAlert Severity="Severity.Warning" Class="mt-2" Dense="true">
                                @L["address.lowConfidence"]
                            </MudAlert>
                        }
                    }
                </MudPaper>
            </MudItem>

            @* Map preview if coordinates available *@
            @if (NormalizedAddress?.Latitude.HasValue == true && NormalizedAddress?.Longitude.HasValue == true)
            {
                <MudItem xs="12">
                    <MudPaper Class="pa-2" Elevation="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-1">
                            <MudText Typo="Typo.caption">
                                Location: @NormalizedAddress.Latitude.Value.ToString("F6"), @NormalizedAddress.Longitude.Value.ToString("F6")
                            </MudText>
                            <MudLink Href="@GetMapLink()" Target="_blank" Typo="Typo.caption">
                                @L["common.viewOnMap"]
                            </MudLink>
                        </MudStack>
                        @* OpenStreetMap embed *@
                        <iframe src="@GetMapImageUrl()"
                                style="width: 100%; height: 180px; border: none; border-radius: 4px;"
                                loading="lazy">
                        </iframe>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="OnCancel">@L["common.cancel"]</MudButton>
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Default"
                   OnClick="OnKeepOriginal">
            @L["address.keepOriginal"]
        </MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="OnUseNormalized">
            @L["address.useNormalized"]
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public bool Visible { get; set; }

    [Parameter]
    public EventCallback<bool> VisibleChanged { get; set; }

    [Parameter]
    public AddressForm.AddressEditModel? OriginalAddress { get; set; }

    [Parameter]
    public NormalizedAddressResult? NormalizedAddress { get; set; }

    [Parameter]
    public EventCallback<AddressConfirmationResult> OnConfirm { get; set; }

    private string BuildCityStateZip(AddressForm.AddressEditModel? address)
    {
        if (address == null) return string.Empty;

        var parts = new List<string>();
        if (!string.IsNullOrWhiteSpace(address.City)) parts.Add(address.City);
        if (!string.IsNullOrWhiteSpace(address.StateProvince)) parts.Add(address.StateProvince);
        if (!string.IsNullOrWhiteSpace(address.PostalCode)) parts.Add(address.PostalCode);
        return string.Join(", ", parts);
    }

    private string BuildCityStateZipFromResult(NormalizedAddressResult? address)
    {
        if (address == null) return string.Empty;

        var parts = new List<string>();
        if (!string.IsNullOrWhiteSpace(address.City)) parts.Add(address.City);
        if (!string.IsNullOrWhiteSpace(address.StateProvince)) parts.Add(address.StateProvince);
        if (!string.IsNullOrWhiteSpace(address.PostalCode)) parts.Add(address.PostalCode);
        return string.Join(", ", parts);
    }

    private string GetMapImageUrl()
    {
        if (NormalizedAddress?.Latitude == null || NormalizedAddress?.Longitude == null)
            return string.Empty;

        var lat = NormalizedAddress.Latitude.Value;
        var lng = NormalizedAddress.Longitude.Value;

        // Use OpenStreetMap embedded map (no API key needed)
        return $"https://www.openstreetmap.org/export/embed.html?bbox={lng - 0.005},{lat - 0.003},{lng + 0.005},{lat + 0.003}&layer=mapnik&marker={lat},{lng}";
    }

    private string GetMapLink()
    {
        if (NormalizedAddress?.Latitude == null || NormalizedAddress?.Longitude == null)
            return string.Empty;

        var lat = NormalizedAddress.Latitude.Value;
        var lng = NormalizedAddress.Longitude.Value;

        return $"https://www.openstreetmap.org/?mlat={lat}&mlon={lng}#map=17/{lat}/{lng}";
    }

    private async Task OnCancel()
    {
        await OnConfirm.InvokeAsync(new AddressConfirmationResult { Action = AddressConfirmationAction.Cancel });
        await VisibleChanged.InvokeAsync(false);
    }

    private async Task OnKeepOriginal()
    {
        await OnConfirm.InvokeAsync(new AddressConfirmationResult { Action = AddressConfirmationAction.KeepOriginal });
        await VisibleChanged.InvokeAsync(false);
    }

    private async Task OnUseNormalized()
    {
        await OnConfirm.InvokeAsync(new AddressConfirmationResult
        {
            Action = AddressConfirmationAction.UseNormalized,
            NormalizedAddress = NormalizedAddress
        });
        await VisibleChanged.InvokeAsync(false);
    }

    public enum AddressConfirmationAction
    {
        Cancel,
        KeepOriginal,
        UseNormalized
    }

    public class AddressConfirmationResult
    {
        public AddressConfirmationAction Action { get; set; }
        public NormalizedAddressResult? NormalizedAddress { get; set; }
    }
}
