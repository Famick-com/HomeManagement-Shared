@inject IApiClient ApiClient
@inject ISnackbar Snackbar
@inject ILocalizer L
@using Famick.HomeManagement.Core.DTOs.Home
@using Famick.HomeManagement.Domain.Enums

<MudDialog @bind-Visible="Visible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            @(IsEditing ? L["home.editUtility"] : L["home.addUtility"])
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="_formValid">
            <MudStack Spacing="3">
                @if (!IsEditing)
                {
                    <MudSelect T="UtilityType" @bind-Value="_utilityType"
                               Label="@L["home.utilityType"]"
                               Variant="Variant.Outlined"
                               Required="true"
                               RequiredError="@L["validation.required", L["home.utilityType"]]">
                        <MudSelectItem Value="UtilityType.Electric">@L["home.utility.electric"]</MudSelectItem>
                        <MudSelectItem Value="UtilityType.Gas">@L["home.utility.gas"]</MudSelectItem>
                        <MudSelectItem Value="UtilityType.WaterSewer">@L["home.utility.waterSewer"]</MudSelectItem>
                        <MudSelectItem Value="UtilityType.TrashRecycling">@L["home.utility.trashRecycling"]</MudSelectItem>
                        <MudSelectItem Value="UtilityType.Internet">@L["home.utility.internet"]</MudSelectItem>
                        <MudSelectItem Value="UtilityType.TvStreaming">@L["home.utility.tvStreaming"]</MudSelectItem>
                        <MudSelectItem Value="UtilityType.SecuritySystem">@L["home.utility.securitySystem"]</MudSelectItem>
                        <MudSelectItem Value="UtilityType.HoaDuesPortal">@L["home.utility.hoaDues"]</MudSelectItem>
                    </MudSelect>
                }
                else
                {
                    <MudTextField Value="@Utility?.UtilityTypeName"
                                  Label="@L["home.utilityType"]"
                                  Variant="Variant.Outlined"
                                  ReadOnly="true" />
                }

                <MudTextField @bind-Value="_companyName"
                              Label="@L["home.company"]"
                              Variant="Variant.Outlined" />

                <MudTextField @bind-Value="_accountNumber"
                              Label="@L["home.accountNumber"]"
                              Variant="Variant.Outlined" />

                <MudTextField @bind-Value="_phoneNumber"
                              Label="@L["home.phone"]"
                              Variant="Variant.Outlined"
                              Mask="@(new PatternMask("(000) 000-0000"))" />

                <MudTextField @bind-Value="_website"
                              Label="@L["home.website"]"
                              Variant="Variant.Outlined" />

                <MudTextField @bind-Value="_loginEmail"
                              Label="@L["home.loginEmail"]"
                              Variant="Variant.Outlined" />

                <MudTextField @bind-Value="_notes"
                              Label="@L["home.notes"]"
                              Variant="Variant.Outlined"
                              Lines="2" />
            </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">@L["common.cancel"]</MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="Save"
                   Disabled="@(!_formValid || _isSaving)">
            @if (_isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            @L["common.save"]
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public bool Visible { get; set; }

    [Parameter]
    public EventCallback<bool> VisibleChanged { get; set; }

    [Parameter]
    public HomeUtilityDto? Utility { get; set; }

    [Parameter]
    public EventCallback OnSave { get; set; }

    private bool IsEditing => Utility != null;
    private MudForm? _form;
    private bool _formValid = true;
    private bool _isSaving = false;

    // Form fields
    private UtilityType _utilityType = UtilityType.Electric;
    private string? _companyName;
    private string? _accountNumber;
    private string? _phoneNumber;
    private string? _website;
    private string? _loginEmail;
    private string? _notes;

    protected override void OnParametersSet()
    {
        if (Visible && Utility != null)
        {
            // Edit mode - populate fields
            _utilityType = Utility.UtilityType;
            _companyName = Utility.CompanyName;
            _accountNumber = Utility.AccountNumber;
            _phoneNumber = Utility.PhoneNumber;
            _website = Utility.Website;
            _loginEmail = Utility.LoginEmail;
            _notes = Utility.Notes;
        }
        else if (Visible && Utility == null)
        {
            // Add mode - reset fields
            ResetForm();
        }
    }

    private void ResetForm()
    {
        _utilityType = UtilityType.Electric;
        _companyName = null;
        _accountNumber = null;
        _phoneNumber = null;
        _website = null;
        _loginEmail = null;
        _notes = null;
    }

    private async Task Close()
    {
        Visible = false;
        await VisibleChanged.InvokeAsync(false);
        ResetForm();
    }

    private async Task Save()
    {
        _isSaving = true;
        try
        {
            if (IsEditing && Utility != null)
            {
                var request = new UpdateHomeUtilityRequest
                {
                    CompanyName = _companyName,
                    AccountNumber = _accountNumber,
                    PhoneNumber = _phoneNumber,
                    Website = _website,
                    LoginEmail = _loginEmail,
                    Notes = _notes
                };

                var result = await ApiClient.PutAsync<UpdateHomeUtilityRequest, HomeUtilityDto>(
                    $"api/v1/home/utilities/{Utility.Id}", request);

                if (result.IsSuccess)
                {
                    Snackbar.Add(L["home.utilitySaved"], Severity.Success);
                    await OnSave.InvokeAsync();
                    await Close();
                }
                else
                {
                    Snackbar.Add(result.ErrorMessage ?? L["common.error"], Severity.Error);
                }
            }
            else
            {
                var request = new CreateHomeUtilityRequest
                {
                    UtilityType = _utilityType,
                    CompanyName = _companyName,
                    AccountNumber = _accountNumber,
                    PhoneNumber = _phoneNumber,
                    Website = _website,
                    LoginEmail = _loginEmail,
                    Notes = _notes
                };

                var result = await ApiClient.PostAsync<CreateHomeUtilityRequest, HomeUtilityDto>(
                    "api/v1/home/utilities", request);

                if (result.IsSuccess)
                {
                    Snackbar.Add(L["home.utilityAdded"], Severity.Success);
                    await OnSave.InvokeAsync();
                    await Close();
                }
                else
                {
                    Snackbar.Add(result.ErrorMessage ?? L["common.error"], Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }
}
