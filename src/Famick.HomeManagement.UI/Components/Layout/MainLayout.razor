@inherits LayoutComponentBase
@implements IDisposable
@using Famick.HomeManagement.UI.Theme
@using Famick.HomeManagement.UI.Services
@using Famick.HomeManagement.Core.Services
@inject ILocalizer L
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject IVersionService VersionService
@inject IUserPermissions UserPermissions

<CascadingValue Value="@_canEdit" Name="CanEdit">
<LocalizationInitializer>
    <MudThemeProvider Theme="FamickTheme.Theme" IsDarkMode="_isDarkMode" />
    <MudPopoverProvider />
    <MudDialogProvider />
    <MudSnackbarProvider />

    <MudLayout>
        <MudAppBar Elevation="1">
            @* Desktop: Menu button *@
            <MudHidden Breakpoint="Breakpoint.SmAndDown">
                <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
            </MudHidden>
            @* Mobile: Back button when on detail page, otherwise menu *@
            <MudHidden Breakpoint="Breakpoint.MdAndUp">
                @if (_canGoBack)
                {
                    <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Inherit" Edge="Edge.Start" OnClick="@GoBack" />
                }
                else
                {
                    <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
                }
            </MudHidden>
            <MudImage Src="_content/Famick.HomeManagement.UI/images/icon.svg" Height="28" Class="ml-1" Alt="Famick" />
            <MudText Typo="Typo.h6" Class="ml-1" Style="white-space: nowrap;">@L["nav.homeManagement"]</MudText>
            <MudSpacer />
            <LanguageSelector />
            <MudTooltip Text="@(_isDarkMode ? L["settings.switchToLightMode"] : L["settings.switchToDarkMode"])">
                <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                               Color="Color.Inherit"
                               OnClick="@ToggleDarkMode" />
            </MudTooltip>
            <LoginDisplay />
        </MudAppBar>

        <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
            <div class="d-flex flex-column" style="height: 100%;">
                <NavMenu />
                <MudSpacer />
                <MudText Typo="Typo.caption" Class="pa-2" Style="color: var(--mud-palette-text-secondary); opacity: 0.6;">
                    v@(VersionService.Version)
                </MudText>
            </div>
        </MudDrawer>

        @* Desktop: Normal padding and container *@
        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <MudMainContent Class="pt-16 px-4">
                <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="my-4">
                    @Body
                </MudContainer>
            </MudMainContent>
        </MudHidden>

        @* Mobile: Minimal padding, no container constraints *@
        <MudHidden Breakpoint="Breakpoint.MdAndUp">
            <MudMainContent Class="pt-16 px-2">
                <div class="py-2">
                    @Body
                </div>
            </MudMainContent>
        </MudHidden>
    </MudLayout>
</LocalizationInitializer>
</CascadingValue>

@code {
    private bool _drawerOpen = true;
    private bool _isDarkMode = false;
    private bool _canGoBack = false;
    private bool _canEdit = false;

    // Pages that are considered "root" pages (no back button)
    private static readonly string[] RootPages = { "/", "/products", "/stock", "/locations", "/quantity-units", "/settings", "/login" };

    protected override async Task OnInitializedAsync()
    {
        Navigation.LocationChanged += OnLocationChanged;
        UpdateCanGoBack();

        // Check user edit permissions (Admin/Editor can edit, Viewer is read-only)
        _canEdit = await UserPermissions.CanEditAsync();
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateCanGoBack();
        StateHasChanged();
    }

    private void UpdateCanGoBack()
    {
        var path = new Uri(Navigation.Uri).AbsolutePath.ToLowerInvariant();
        // Show back button if not on a root page
        _canGoBack = !RootPages.Any(p => path.Equals(p, StringComparison.OrdinalIgnoreCase));
    }

    private async Task GoBack()
    {
        await JS.InvokeVoidAsync("history.back");
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
