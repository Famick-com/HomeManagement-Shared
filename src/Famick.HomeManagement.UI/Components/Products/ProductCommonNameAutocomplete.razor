@using Famick.HomeManagement.Core.DTOs.ProductCommonNames
@using Famick.HomeManagement.Core.Interfaces
@inject IApiClient ApiClient
@inject ILocalizer L
@inject ISnackbar Snackbar

<MudAutocomplete T="ProductCommonNameDto"
                 Label="@L["products.commonName"]"
                 HelperText="@L["products.commonNameHint"]"
                 Variant="Variant.Outlined"
                 SearchFunc="SearchCommonNamesAsync"
                 ToStringFunc="@(c => c?.Name ?? "")"
                 Value="@SelectedCommonName"
                 ValueChanged="HandleValueChanged"
                 Clearable="true"
                 ShowProgressIndicator="true"
                 DebounceInterval="300"
                 Disabled="@(!CanEdit)"
                 CoerceText="false"
                 CoerceValue="false"
                 ResetValueOnEmptyText="true">
    <ItemTemplate Context="commonName">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="flex-grow-1">
            <MudText>@commonName.Name</MudText>
            <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Text">
                @commonName.ProductCount @(commonName.ProductCount == 1 ? "product" : "products")
            </MudChip>
        </MudStack>
    </ItemTemplate>
    <NoItemsTemplate>
        @if (!string.IsNullOrWhiteSpace(_currentSearchText) && CanEdit)
        {
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="pa-2">
                <MudText Typo="Typo.body2">No matches found.</MudText>
                <MudButton Variant="Variant.Text"
                           Color="Color.Primary"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="@(() => CreateNewCommonNameAsync(_currentSearchText))"
                           Disabled="@_isCreating">
                    @if (_isCreating)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    @L["products.createCommonName"] "@_currentSearchText"
                </MudButton>
            </MudStack>
        }
        else
        {
            <MudText Typo="Typo.body2" Class="pa-2">No matches found.</MudText>
        }
    </NoItemsTemplate>
</MudAutocomplete>

@code {
    [Parameter]
    public ProductCommonNameDto? SelectedCommonName { get; set; }

    [Parameter]
    public EventCallback<ProductCommonNameDto?> SelectedCommonNameChanged { get; set; }

    [Parameter]
    public bool CanEdit { get; set; } = true;

    private string _currentSearchText = string.Empty;
    private bool _isCreating;

    private async Task<IEnumerable<ProductCommonNameDto>> SearchCommonNamesAsync(string searchText, CancellationToken cancellationToken)
    {
        _currentSearchText = searchText ?? string.Empty;

        if (string.IsNullOrWhiteSpace(searchText))
        {
            // Return all common names when search is empty (limited to reasonable amount)
            var allResult = await ApiClient.GetAsync<List<ProductCommonNameDto>>(
                "api/v1/productcommonnames?sortBy=name");

            if (allResult.IsSuccess && allResult.Data != null)
            {
                return allResult.Data.Take(50);
            }
            return Enumerable.Empty<ProductCommonNameDto>();
        }

        var result = await ApiClient.GetAsync<List<ProductCommonNameDto>>(
            $"api/v1/productcommonnames?searchTerm={Uri.EscapeDataString(searchText)}&sortBy=name");

        if (result.IsSuccess && result.Data != null)
        {
            return result.Data;
        }

        return Enumerable.Empty<ProductCommonNameDto>();
    }

    private async Task HandleValueChanged(ProductCommonNameDto? value)
    {
        SelectedCommonName = value;
        await SelectedCommonNameChanged.InvokeAsync(value);
    }

    private async Task CreateNewCommonNameAsync(string name)
    {
        if (string.IsNullOrWhiteSpace(name) || _isCreating) return;

        _isCreating = true;
        StateHasChanged();

        try
        {
            var request = new CreateProductCommonNameRequest
            {
                Name = name.Trim()
            };

            var result = await ApiClient.PostAsync<CreateProductCommonNameRequest, ProductCommonNameDto>(
                "api/v1/productcommonnames",
                request);

            if (result.IsSuccess && result.Data != null)
            {
                Snackbar.Add(L["products.commonNameCreated"], Severity.Success);
                await HandleValueChanged(result.Data);
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? L["errors.generic"], Severity.Error);
            }
        }
        catch (Exception)
        {
            Snackbar.Add(L["errors.generic"], Severity.Error);
        }
        finally
        {
            _isCreating = false;
            StateHasChanged();
        }
    }
}
