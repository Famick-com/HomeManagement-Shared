@using Famick.HomeManagement.Core.DTOs.ProductGroups
@using Famick.HomeManagement.Core.Interfaces
@inject IApiClient ApiClient
@inject ISnackbar Snackbar
@inject ILocalizer L

<MudAutocomplete T="ProductGroupDto"
                 Label="@L["products.productGroup"]"
                 HelperText="@L["products.productGroupHint"]"
                 Variant="Variant.Outlined"
                 SearchFunc="SearchProductGroupsAsync"
                 ToStringFunc="@(g => g?.Name ?? "")"
                 Value="@_selectedProductGroup"
                 ValueChanged="HandleValueChanged"
                 Clearable="true"
                 ShowProgressIndicator="true"
                 DebounceInterval="300"
                 Disabled="@(!CanEdit)"
                 CoerceText="false"
                 CoerceValue="false"
                 ResetValueOnEmptyText="true">
    <ItemTemplate Context="group">
        @if (group.Id == Guid.Empty)
        {
            @* This is the "Create new" option *@
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Size="Size.Small" />
                <MudText Color="Color.Primary">@L["products.createProductGroup"]: "@group.Name"</MudText>
            </MudStack>
        }
        else
        {
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="flex-grow-1">
                <MudText>@group.Name</MudText>
                @if (group.ProductCount > 0)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text">
                        @group.ProductCount @(group.ProductCount == 1 ? "product" : "products")
                    </MudChip>
                }
            </MudStack>
        }
    </ItemTemplate>
    <NoItemsTemplate>
        <MudText Typo="Typo.body2" Class="pa-2">@L["common.noResults"]</MudText>
    </NoItemsTemplate>
</MudAutocomplete>

@code {
    /// <summary>
    /// The currently selected product group ID.
    /// </summary>
    [Parameter]
    public Guid? SelectedProductGroupId { get; set; }

    /// <summary>
    /// Callback when the selected product group ID changes.
    /// </summary>
    [Parameter]
    public EventCallback<Guid?> SelectedProductGroupIdChanged { get; set; }

    /// <summary>
    /// Whether editing is allowed (false for Viewer role).
    /// </summary>
    [Parameter]
    public bool CanEdit { get; set; } = true;

    private ProductGroupDto? _selectedProductGroup;
    private List<ProductGroupDto> _allProductGroups = new();
    private bool _isInitialized;

    protected override async Task OnInitializedAsync()
    {
        await LoadProductGroupsAsync();
        _isInitialized = true;
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_isInitialized && SelectedProductGroupId.HasValue)
        {
            // Find the matching product group from our loaded list
            _selectedProductGroup = _allProductGroups.FirstOrDefault(g => g.Id == SelectedProductGroupId.Value);

            // If not found in list, try to load it directly
            if (_selectedProductGroup == null && SelectedProductGroupId.Value != Guid.Empty)
            {
                await LoadProductGroupsAsync();
                _selectedProductGroup = _allProductGroups.FirstOrDefault(g => g.Id == SelectedProductGroupId.Value);
            }
        }
        else if (_isInitialized && !SelectedProductGroupId.HasValue)
        {
            _selectedProductGroup = null;
        }
    }

    private async Task LoadProductGroupsAsync()
    {
        try
        {
            var result = await ApiClient.GetAsync<List<ProductGroupDto>>("api/v1/productgroups");
            if (result.IsSuccess && result.Data != null)
            {
                _allProductGroups = result.Data.OrderBy(g => g.Name).ToList();
            }
        }
        catch
        {
            // Silently fail - groups are optional
        }
    }

    private Task<IEnumerable<ProductGroupDto>> SearchProductGroupsAsync(string searchText, CancellationToken cancellationToken)
    {
        var results = new List<ProductGroupDto>();

        if (string.IsNullOrWhiteSpace(searchText))
        {
            // Return all groups when no search text
            results.AddRange(_allProductGroups);
        }
        else
        {
            // Filter locally by name
            var filtered = _allProductGroups
                .Where(g => g.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase))
                .ToList();

            results.AddRange(filtered);

            // Add "Create new" option if user has typed something and no exact match exists
            if (CanEdit)
            {
                var exactMatch = _allProductGroups.Any(g => g.Name.Equals(searchText, StringComparison.OrdinalIgnoreCase));
                if (!exactMatch)
                {
                    results.Insert(0, new ProductGroupDto
                    {
                        Id = Guid.Empty, // Marker for "create new"
                        Name = searchText.Trim()
                    });
                }
            }
        }

        return Task.FromResult<IEnumerable<ProductGroupDto>>(results);
    }

    private async Task HandleValueChanged(ProductGroupDto? value)
    {
        if (value != null && value.Id == Guid.Empty)
        {
            // User selected "Create new" option
            var newGroup = await CreateProductGroupAsync(value.Name);
            if (newGroup != null)
            {
                _selectedProductGroup = newGroup;
                await SelectedProductGroupIdChanged.InvokeAsync(newGroup.Id);
            }
            // If creation failed, don't update the selection
            return;
        }

        _selectedProductGroup = value;
        await SelectedProductGroupIdChanged.InvokeAsync(value?.Id);
    }

    private async Task<ProductGroupDto?> CreateProductGroupAsync(string name)
    {
        var request = new CreateProductGroupRequest
        {
            Name = name
        };

        var result = await ApiClient.PostAsync<CreateProductGroupRequest, ProductGroupDto>("api/v1/productgroups", request);

        if (result.IsSuccess && result.Data != null)
        {
            Snackbar.Add(L["products.productGroupCreated"], Severity.Success);
            // Add to our local list so it's available for future searches
            _allProductGroups.Add(result.Data);
            _allProductGroups = _allProductGroups.OrderBy(g => g.Name).ToList();
            return result.Data;
        }
        else
        {
            Snackbar.Add(result.ErrorMessage ?? L["errors.generic"], Severity.Error);
            return null;
        }
    }
}
