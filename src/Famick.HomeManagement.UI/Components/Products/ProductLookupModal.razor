@using Famick.HomeManagement.Core.Interfaces
@using Famick.HomeManagement.Core.Interfaces.Plugins
@using Famick.HomeManagement.Core.DTOs.ProductLookup
@using Famick.HomeManagement.Core.DTOs.ShoppingLocations
@using Famick.HomeManagement.Core.DTOs.StoreIntegrations
@inject IApiClient ApiClient
@inject IBarcodeScannerService BarcodeScanner
@inject ISnackbar Snackbar
@inject ILocalizer L
@inject NavigationManager NavigationManager

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">@L["productLookup.title"]</MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            @* Search input with optional camera button *@
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudTextField @bind-Value="_searchQuery"
                              Label="@L["productLookup.searchPlaceholder"]"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              AdornmentColor="Color.Primary"
                              OnAdornmentClick="SearchAsync"
                              OnKeyDown="HandleKeyDown"
                              Immediate="true"
                              Class="flex-grow-1" />

                @if (BarcodeScanner.IsAvailable)
                {
                    <MudTooltip Text="@L["productLookup.scanBarcode"]">
                        <MudIconButton Icon="@Icons.Material.Filled.CameraAlt"
                                       Color="Color.Primary"
                                       Variant="Variant.Filled"
                                       Size="Size.Large"
                                       OnClick="ScanBarcodeAsync" />
                    </MudTooltip>
                }
            </MudStack>

            @* Search mode toggle (only show if connected store integrations exist) *@
            @if (_hasConnectedStoreIntegrations)
            {
                <MudToggleGroup T="ProductSearchMode"
                                @bind-Value="_searchMode"
                                Color="Color.Primary"
                                Size="Size.Small"
                                Rounded="true"
                                CheckMark="true"
                                Class="mb-1">
                    <MudToggleItem Value="ProductSearchMode.StoreIntegrationsOnly">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.Store" Size="Size.Small" />
                            <MudText Typo="Typo.body2">@L["productLookup.myStores"]</MudText>
                        </MudStack>
                    </MudToggleItem>
                    <MudToggleItem Value="ProductSearchMode.AllSources">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.Search" Size="Size.Small" />
                            <MudText Typo="Typo.body2">@L["productLookup.allSources"]</MudText>
                        </MudStack>
                    </MudToggleItem>
                </MudToggleGroup>
            }

            @* Store selector (only show if there are stores with integrations) *@
            @if (_shoppingLocations.Count > 0)
            {
                <MudSelect T="Guid?" @bind-Value="_selectedShoppingLocationId"
                           Label="@L["productLookup.preferredStore"]"
                           Variant="Variant.Outlined"
                           Dense="true"
                           AnchorOrigin="Origin.BottomCenter"
                           Clearable="true">
                    @foreach (var location in _shoppingLocations)
                    {
                        <MudSelectItem T="Guid?" Value="@location.Id">
                            @location.Name
                            @if (!string.IsNullOrEmpty(location.IntegrationType))
                            {
                                <MudText Typo="Typo.caption" Class="ml-2" Color="Color.Secondary">
                                    (@location.IntegrationType)
                                </MudText>
                            }
                        </MudSelectItem>
                    }
                </MudSelect>
            }

            @* Search type indicator *@
            @if (!string.IsNullOrWhiteSpace(_searchQuery))
            {
                <MudText Typo="Typo.caption" Color="Color.Info">
                    @(IsBarcode(_searchQuery)
                        ? L["productLookup.searchingByBarcode"]
                        : L["productLookup.searchingByName"])
                </MudText>
            }

            @* Store connection status banners *@
            @foreach (var status in _storeStatuses.Where(s => !s.IsConnected))
            {
                <MudAlert Severity="Severity.Info" Dense="true" Class="py-1">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.body2">
                            @L["productLookup.connectToSearch", status.PluginDisplayName]
                        </MudText>
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Primary"
                                   Size="Size.Small"
                                   OnClick="() => ConnectStore(status)">
                            @L["storeIntegration.connect"]
                        </MudButton>
                    </MudStack>
                </MudAlert>
            }

            @* Loading indicator *@
            @if (_isSearching)
            {
                <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
            }

            @* Results list *@
            @if (_searchResults.Count > 0)
            {
                <MudText Typo="Typo.subtitle2" Class="mb-2">
                    @L["productLookup.resultsCount", _searchResults.Count]
                </MudText>

                <MudList T="ProductLookupResultDto" Dense="true" Class="overflow-auto product-lookup-results">
                    @foreach (var result in _searchResults)
                    {
                        <MudListItem T="ProductLookupResultDto"
                                     OnClick="() => SelectResult(result)"
                                     Class="cursor-pointer hover-highlight">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Start">
                                @* Product thumbnail *@
                                @if (!string.IsNullOrEmpty(result.ThumbnailUrl))
                                {
                                    <MudImage Src="@result.ThumbnailUrl"
                                              Width="48" Height="48"
                                              ObjectFit="ObjectFit.Cover"
                                              Class="rounded"
                                              Alt="@result.Name" />
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Outlined.Image"
                                             Size="Size.Large"
                                             Color="Color.Default"
                                             Style="width:48px;height:48px;opacity:0.3;" />
                                }

                                @* Product details *@
                                <MudStack Spacing="0" Class="flex-grow-1">
                                    @* Name with source badge *@
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="flex-wrap">
                                        <MudText Typo="Typo.body1">@result.Name</MudText>
                                        <MudChip T="string"
                                                 Size="Size.Small"
                                                 Color="@GetSourceColor(result)"
                                                 Variant="Variant.Filled"
                                                 Class="px-2 py-0"
                                                 Style="height: 20px; font-size: 0.7rem;">
                                            @result.PluginDisplayName
                                        </MudChip>
                                        @if (!string.IsNullOrEmpty(result.Category))
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                                                @result.Category
                                            </MudChip>
                                        }
                                    </MudStack>

                                    @* Brand *@
                                    @if (!string.IsNullOrEmpty(result.Brand) || !string.IsNullOrEmpty(result.BrandOwner))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @(result.Brand ?? result.BrandOwner)
                                        </MudText>
                                    }

                                    @* Store-specific info (price, aisle) *@
                                    @if (result.SourceType == "StoreIntegration")
                                    {
                                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mt-1">
                                            @if (result.Price.HasValue)
                                            {
                                                <MudChip T="string"
                                                         Size="Size.Small"
                                                         Color="Color.Success"
                                                         Variant="Variant.Filled"
                                                         Class="px-2 py-0"
                                                         Style="height: 20px;">
                                                    @FormatPrice(result.Price, result.PriceUnit)
                                                </MudChip>
                                            }
                                            @if (!string.IsNullOrEmpty(result.Aisle))
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    @L["storeIntegration.aisle"]: @result.Aisle
                                                </MudText>
                                            }
                                            @if (result.InStock == true)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle"
                                                         Color="Color.Success"
                                                         Size="Size.Small"
                                                         Title="@L["storeIntegration.inStock"]" />
                                            }
                                            else if (result.InStock == false)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Cancel"
                                                         Color="Color.Error"
                                                         Size="Size.Small"
                                                         Title="@L["storeIntegration.outOfStock"]" />
                                            }
                                        </MudStack>
                                    }

                                    @* Barcode *@
                                    @if (!string.IsNullOrEmpty(result.Barcode))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Tertiary">
                                            @L["productLookup.barcode"]: @result.Barcode
                                        </MudText>
                                    }

                                    @* Nutrition info for product plugins *@
                                    @if (result.Nutrition?.Calories.HasValue == true)
                                    {
                                        <MudText Typo="Typo.caption">
                                            @L["productLookup.calories"]: @result.Nutrition.Calories
                                        </MudText>
                                    }
                                </MudStack>
                            </MudStack>
                        </MudListItem>
                        <MudDivider />
                    }
                </MudList>
            }
            else if (_hasSearched && !_isSearching)
            {
                <MudAlert Severity="Severity.Info">
                    @L["productLookup.noResults"]
                </MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@L["common.cancel"]</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public string? InitialQuery { get; set; }

    /// <summary>
    /// Preferred shopping location ID for store integration searches.
    /// If provided, also searches the connected store for products.
    /// </summary>
    [Parameter]
    public Guid? PreferredShoppingLocationId { get; set; }

    private string _searchQuery = string.Empty;
    private bool _isSearching;
    private bool _hasSearched;
    private List<ProductLookupResultDto> _searchResults = new();
    private List<StoreConnectionStatus> _storeStatuses = new();
    private List<ShoppingLocationDto> _shoppingLocations = new();
    private Guid? _selectedShoppingLocationId;
    private bool _hasConnectedStoreIntegrations;
    private ProductSearchMode _searchMode = ProductSearchMode.AllSources;

    protected override async Task OnInitializedAsync()
    {
        // Load shopping locations with store integrations
        await LoadShoppingLocationsAsync();

        // Check for connected store integrations
        await CheckConnectedStoreIntegrationsAsync();

        // Set initial selection from parameter
        _selectedShoppingLocationId = PreferredShoppingLocationId;

        if (!string.IsNullOrWhiteSpace(InitialQuery))
        {
            _searchQuery = InitialQuery;
            await SearchAsync();
        }
    }

    private async Task CheckConnectedStoreIntegrationsAsync()
    {
        try
        {
            var result = await ApiClient.GetAsync<List<StoreIntegrationPluginInfo>>(
                "api/v1/storeintegrations/plugins");

            if (result.IsSuccess && result.Data != null)
            {
                // Check if any store integration is connected and doesn't require re-auth
                _hasConnectedStoreIntegrations = result.Data.Any(p => p.IsConnected && !p.RequiresReauth);

                // Default to store-only search if connected stores exist
                if (_hasConnectedStoreIntegrations)
                {
                    _searchMode = ProductSearchMode.StoreIntegrationsOnly;
                }
            }
        }
        catch
        {
            // Silently fail - default to all sources
            _hasConnectedStoreIntegrations = false;
        }
    }

    private async Task LoadShoppingLocationsAsync()
    {
        try
        {
            var result = await ApiClient.GetAsync<List<ShoppingLocationDto>>("api/v1/shopping-locations");
            if (result.IsSuccess && result.Data != null)
            {
                // Only show locations that have store integrations configured
                _shoppingLocations = result.Data
                    .Where(sl => !string.IsNullOrEmpty(sl.IntegrationType))
                    .OrderBy(sl => sl.Name)
                    .ToList();
            }
        }
        catch
        {
            // Silently fail - store selection is optional
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_searchQuery))
        {
            await SearchAsync();
        }
    }

    private async Task SearchAsync()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery))
        {
            return;
        }

        _isSearching = true;
        _hasSearched = true;
        _searchResults.Clear();
        _storeStatuses.Clear();
        StateHasChanged(); // Force re-render to show loading indicator

        try
        {
            var request = new ProductLookupRequest
            {
                Query = _searchQuery.Trim(),
                MaxResults = 20,
                PreferredShoppingLocationId = _selectedShoppingLocationId,
                IncludeStoreResults = true,
                SearchMode = _searchMode
            };

            var result = await ApiClient.PostAsync<ProductLookupRequest, ProductLookupResponse>(
                "api/v1/products/lookup", request);

            if (result.IsSuccess && result.Data != null)
            {
                _searchResults = result.Data.Results;
                _storeStatuses = result.Data.StoreConnectionStatuses;
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? L["errors.generic"], Severity.Error);
            }
        }
        catch (Exception)
        {
            Snackbar.Add(L["errors.generic"], Severity.Error);
        }
        finally
        {
            _isSearching = false;
        }
    }

    private async Task ScanBarcodeAsync()
    {
        try
        {
            var barcode = await BarcodeScanner.ScanBarcodeAsync();

            if (!string.IsNullOrEmpty(barcode))
            {
                _searchQuery = barcode;
                await SearchAsync();
            }
        }
        catch (Exception)
        {
            Snackbar.Add(L["productLookup.scanError"], Severity.Error);
        }
    }

    private void SelectResult(ProductLookupResultDto result)
    {
        MudDialog.Close(DialogResult.Ok(result));
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private void ConnectStore(StoreConnectionStatus status)
    {
        // Navigate to store integration settings
        MudDialog.Cancel();
        if (status.ShoppingLocationId.HasValue)
        {
            NavigationManager.NavigateTo($"/settings/shopping-locations/{status.ShoppingLocationId}/integration");
        }
        else
        {
            NavigationManager.NavigateTo("/settings/integrations");
        }
    }

    private static Color GetSourceColor(ProductLookupResultDto result)
    {
        return result.SourceType == "StoreIntegration" ? Color.Primary : Color.Secondary;
    }

    private string FormatPrice(decimal? price, string? unit)
    {
        if (!price.HasValue) return "";
        var formatted = price.Value.ToString("C");
        if (!string.IsNullOrEmpty(unit) && unit != "each")
        {
            formatted += $"/{unit}";
        }
        return formatted;
    }

    private static bool IsBarcode(string input)
    {
        if (string.IsNullOrWhiteSpace(input)) return false;
        var cleaned = input.Trim().Replace("-", "").Replace(" ", "");
        return System.Text.RegularExpressions.Regex.IsMatch(cleaned, @"^[0-9]{8,14}$");
    }
}
