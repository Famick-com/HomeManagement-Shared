@page "/reset-password"
@layout EmptyLayout
@inject IApiClient ApiClient
@inject NavigationManager Navigation
@inject ILocalizer L
@using Famick.HomeManagement.UI.Theme
@using Famick.HomeManagement.Core.DTOs.Authentication

<LocalizationInitializer>
    <MudThemeProvider Theme="FamickTheme.Theme" IsDarkMode="false" />
    <MudPopoverProvider />
    <MudDialogProvider />
    <MudSnackbarProvider />

    <MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center" Style="height: 100vh;">
        <MudPaper Elevation="3" Class="pa-8" Style="width: 100%;">
            <MudStack Spacing="4" AlignItems="AlignItems.Center">
                <MudImage Src="_content/Famick.HomeManagement.UI/images/logo-lockup.svg" Height="100" Alt="Famick Home Management" />
                <MudText Typo="Typo.h5">@L["auth.resetPassword"]</MudText>
            </MudStack>

            @if (_isValidating)
            {
                <MudStack Spacing="4" Class="mt-6" AlignItems="AlignItems.Center">
                    <MudProgressCircular Indeterminate="true" />
                    <MudText>@L["auth.validatingToken"]</MudText>
                </MudStack>
            }
            else if (!_tokenValid)
            {
                <MudStack Spacing="4" Class="mt-6">
                    <MudAlert Severity="Severity.Error">
                        @_validationError
                    </MudAlert>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               OnClick="@(() => Navigation.NavigateTo("/forgot-password"))">
                        @L["auth.requestNewLink"]
                    </MudButton>
                </MudStack>
            }
            else if (_resetComplete)
            {
                <MudStack Spacing="4" Class="mt-6">
                    <MudAlert Severity="Severity.Success">
                        @L["auth.passwordResetSuccess"]
                    </MudAlert>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               OnClick="@(() => Navigation.NavigateTo("/login"))">
                        @L["auth.login"]
                    </MudButton>
                </MudStack>
            }
            else
            {
                <MudForm @ref="_form" @bind-IsValid="@_formValid" Class="mt-6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                        @L["auth.resetPasswordFor"] @_email
                    </MudText>

                    <MudTextField @bind-Value="_newPassword"
                                  Label="@L["auth.newPassword"]"
                                  Variant="Variant.Outlined"
                                  InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                                  Required="true"
                                  RequiredError="@L["auth.passwordRequired"]"
                                  Validation="@(new Func<string, string?>(ValidatePassword))"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@(_showPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                  OnAdornmentClick="@(() => _showPassword = !_showPassword)"
                                  Disabled="@_isLoading"
                                  Class="mb-4" />

                    <MudTextField @bind-Value="_confirmPassword"
                                  Label="@L["auth.confirmPassword"]"
                                  Variant="Variant.Outlined"
                                  InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                                  Required="true"
                                  RequiredError="@L["auth.confirmPasswordRequired"]"
                                  Validation="@(new Func<string, string?>(ValidateConfirmPassword))"
                                  Disabled="@_isLoading"
                                  Class="mb-4" />

                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
                    }

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               Size="Size.Large"
                               OnClick="@HandleReset"
                               Disabled="@(!_formValid || _isLoading)">
                        @if (_isLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>@L["auth.resettingPassword"]</span>
                        }
                        else
                        {
                            <span>@L["auth.resetPassword"]</span>
                        }
                    </MudButton>
                </MudForm>
            }
        </MudPaper>
    </MudContainer>
</LocalizationInitializer>

@code {
    [SupplyParameterFromQuery]
    public string? Token { get; set; }

    private MudForm? _form;
    private bool _formValid;
    private bool _isLoading;
    private bool _isValidating = true;
    private bool _tokenValid;
    private bool _resetComplete;
    private bool _showPassword;
    private string _newPassword = string.Empty;
    private string _confirmPassword = string.Empty;
    private string? _email;
    private string? _errorMessage;
    private string? _validationError;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrWhiteSpace(Token))
        {
            _isValidating = false;
            _validationError = L["auth.invalidResetToken"];
            return;
        }

        try
        {
            var result = await ApiClient.ValidateResetTokenAsync(Token);
            if (result.IsSuccess && result.Data != null)
            {
                _tokenValid = result.Data.IsValid;
                _email = result.Data.Email;
                _validationError = result.Data.ErrorMessage;
            }
            else
            {
                _validationError = result.ErrorMessage ?? L["auth.invalidResetToken"];
            }
        }
        catch (Exception)
        {
            _validationError = L["auth.unexpectedError"];
        }
        finally
        {
            _isValidating = false;
        }
    }

    private string? ValidatePassword(string password)
    {
        if (string.IsNullOrEmpty(password))
            return L["auth.passwordRequired"];
        if (password.Length < 8)
            return L["auth.passwordMinLength"];
        return null;
    }

    private string? ValidateConfirmPassword(string confirmPassword)
    {
        if (string.IsNullOrEmpty(confirmPassword))
            return L["auth.confirmPasswordRequired"];
        if (confirmPassword != _newPassword)
            return L["auth.passwordsDoNotMatch"];
        return null;
    }

    private async Task HandleReset()
    {
        if (_form == null || string.IsNullOrEmpty(Token)) return;

        await _form.Validate();
        if (!_formValid) return;

        _isLoading = true;
        _errorMessage = null;

        try
        {
            var request = new ResetPasswordRequest
            {
                Token = Token,
                NewPassword = _newPassword,
                ConfirmPassword = _confirmPassword
            };

            var result = await ApiClient.ResetPasswordAsync(request);

            if (result.IsSuccess && result.Data?.Success == true)
            {
                _resetComplete = true;
            }
            else
            {
                _errorMessage = result.Data?.Message ?? result.ErrorMessage ?? L["auth.resetFailed"];
            }
        }
        catch (Exception)
        {
            _errorMessage = L["auth.unexpectedError"];
        }
        finally
        {
            _isLoading = false;
        }
    }
}
