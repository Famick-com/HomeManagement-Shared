@page "/inventory-session"
@using Famick.HomeManagement.Core.DTOs.Locations
@using Famick.HomeManagement.Core.DTOs.Products
@using Famick.HomeManagement.Core.DTOs.Stock
@using Famick.HomeManagement.Core.DTOs.ProductLookup
@using Famick.HomeManagement.Core.Interfaces.Plugins
@using Famick.HomeManagement.Core.Interfaces
@using Famick.HomeManagement.UI.Components.Inventory
@using Famick.HomeManagement.UI.Services
@inject IApiClient ApiClient
@inject IBarcodeScannerService BarcodeScanner
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ILocalizer L
@inject NavigationManager NavigationManager

<MudContainer MaxWidth="MaxWidth.Small" Class="pa-4 pt-16">
    <MudStack Spacing="3">
        @* Header with location selector *@
        <MudPaper Elevation="1" Class="pa-3">
            <LocationSelector @bind-SelectedLocationId="_selectedLocationId"
                              LocationChanged="OnLocationChanged" />
        </MudPaper>

        @* Search/scan input *@
        <MudPaper Elevation="1" Class="pa-3">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudTextField @bind-Value="_searchQuery"
                              Label="@L["inventory.scanOrSearch"]"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              AdornmentColor="Color.Primary"
                              OnAdornmentClick="SearchAsync"
                              OnKeyDown="HandleKeyDown"
                              Immediate="true"
                              Class="flex-grow-1"
                              Margin="Margin.Dense" />

                @if (BarcodeScanner.IsAvailable)
                {
                    <MudTooltip Text="@L["inventory.scanBarcode"]">
                        <MudIconButton Icon="@Icons.Material.Filled.CameraAlt"
                                       Color="Color.Primary"
                                       Variant="Variant.Filled"
                                       Size="Size.Large"
                                       OnClick="ScanBarcodeAsync" />
                    </MudTooltip>
                }
            </MudStack>
        </MudPaper>

        @* Loading indicator *@
        @if (_isSearching)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }

        @* Results area *@
        @if (_hasSearched && !_isSearching)
        {
            @if (_foundProduct != null)
            {
                @* Product found in local database *@
                <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center" Class="mt-2 mb-2">
                    @if (GetPrimaryImage(_foundProduct) is { } img && !string.IsNullOrEmpty(img.ThumbnailDisplayUrl))
                    {
                        <MudImage Src="@img.ThumbnailDisplayUrl"
                                  Width="64" Height="64"
                                  ObjectFit="ObjectFit.Cover"
                                  Class="rounded"
                                  Alt="@_foundProduct.Name" />
                    }
                    else
                    {
                        <MudPaper Width="64px" Height="64px" Elevation="0" Class="d-flex align-center justify-center rounded" Style="background: var(--mud-palette-background-grey);">
                            <MudIcon Icon="@Icons.Material.Outlined.Inventory2"
                                     Size="Size.Large"
                                     Color="Color.Default"
                                     Style="opacity: 0.4;" />
                        </MudPaper>
                    }
                    <MudText Typo="Typo.h6">@_foundProduct.Name</MudText>
                </MudStack>

                @if (_stockEntries.Count == 0)
                {
                    @* No stock - prompt to add *@
                    <MudAlert Severity="Severity.Info">
                        @L["inventory.noStock"]
                    </MudAlert>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Add"
                               OnClick="ShowAddStockDialog" FullWidth="true">
                        @L["inventory.addStock"]
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Default"
                               StartIcon="@Icons.Material.Filled.NavigateNext"
                               OnClick="PrepareNextItem" FullWidth="true" Class="mt-2">
                        @L["inventory.nextItem"]
                    </MudButton>
                }
                else
                {
                    @* Show stock entries *@
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                        @L["inventory.stockEntriesCount", _stockEntries.Count]
                    </MudText>

                    @foreach (var entry in _stockEntries)
                    {
                        <StockEntryCard Entry="@entry"
                                        OnEditClick="ShowAdjustDialog"
                                        OnOpenClick="ShowOpenDialog"
                                        OnConsumeClick="ShowConsumeDialog" />
                    }

                    <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Add"
                               OnClick="ShowAddStockDialog" FullWidth="true" Class="mt-2">
                        @L["inventory.addMore"]
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Default"
                               StartIcon="@Icons.Material.Filled.NavigateNext"
                               OnClick="PrepareNextItem" FullWidth="true" Class="mt-2">
                        @L["inventory.nextItem"]
                    </MudButton>
                }
            }
            else if (_lookupResults.Count > 0)
            {
                @* Found in external lookup - show results *@
                <MudText Typo="Typo.subtitle1" Class="mb-2">
                    @L["inventory.externalResults", _lookupResults.Count]
                </MudText>

                @foreach (var result in _lookupResults)
                {
                    <MudCard Elevation="1" Class="mb-2 cursor-pointer" @onclick="() => SelectLookupResult(result)">
                        <MudCardContent Class="pa-3">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Start">
                                @if (!string.IsNullOrEmpty(result.ThumbnailUrl))
                                {
                                    <MudImage Src="@result.ThumbnailUrl" Width="48" Height="48"
                                              ObjectFit="ObjectFit.Cover" Class="rounded" />
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Outlined.Image" Size="Size.Large"
                                             Style="width:48px;height:48px;opacity:0.3;" />
                                }
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body1">@result.Name</MudText>
                                    @if (!string.IsNullOrEmpty(result.BrandName))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@result.BrandName</MudText>
                                    }
                                    @if (!string.IsNullOrEmpty(result.Barcode))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Tertiary">@result.Barcode</MudText>
                                    }
                                </MudStack>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                }
            }
            else
            {
                @* Nothing found *@
                <MudAlert Severity="Severity.Warning">
                    @L["inventory.productNotFound"]
                </MudAlert>
                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="NavigateToCreateProduct" FullWidth="true">
                    @L["inventory.createProduct"]
                </MudButton>
            }
        }
    </MudStack>
</MudContainer>

@code {
    private Guid? _selectedLocationId;
    private LocationDto? _selectedLocation;
    private string _searchQuery = string.Empty;
    private bool _isSearching;
    private bool _hasSearched;

    private ProductDto? _foundProduct;
    private List<StockEntryDto> _stockEntries = new();
    private List<ProductLookupResult> _lookupResults = new();

    private void OnLocationChanged(LocationDto? location)
    {
        _selectedLocation = location;
        // Refresh stock entries if we have a product
        if (_foundProduct != null)
        {
            _ = LoadStockEntriesAsync(_foundProduct.Id);
        }
    }

    private void PrepareNextItem()
    {
        // Clear search state and prepare for next item
        _searchQuery = string.Empty;
        _hasSearched = false;
        _foundProduct = null;
        _stockEntries.Clear();
        _lookupResults.Clear();
        StateHasChanged();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_searchQuery))
        {
            await SearchAsync();
        }
    }

    private async Task ScanBarcodeAsync()
    {
        try
        {
            var barcode = await BarcodeScanner.ScanBarcodeAsync();
            if (!string.IsNullOrEmpty(barcode))
            {
                _searchQuery = barcode;
                await SearchAsync();
            }
        }
        catch
        {
            Snackbar.Add(L["inventory.scanError"], Severity.Error);
        }
    }

    private async Task SearchAsync()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery) || !_selectedLocationId.HasValue)
        {
            if (!_selectedLocationId.HasValue)
            {
                Snackbar.Add(L["inventory.selectLocationFirst"], Severity.Warning);
            }
            return;
        }

        _isSearching = true;
        _hasSearched = true;
        _foundProduct = null;
        _stockEntries.Clear();
        _lookupResults.Clear();

        try
        {
            var query = _searchQuery.Trim();
            var isBarcode = IsBarcode(query);

            // Step 1: Check local products table
            if (isBarcode)
            {
                var result = await ApiClient.GetAsync<ProductDto>($"api/v1/products/by-barcode/{Uri.EscapeDataString(query)}");
                if (result.IsSuccess && result.Data != null)
                {
                    _foundProduct = result.Data;
                }
            }
            else
            {
                // Search by name
                var result = await ApiClient.GetAsync<List<ProductDto>>($"api/v1/products/search?q={Uri.EscapeDataString(query)}");
                if (result.IsSuccess && result.Data?.Count > 0)
                {
                    // If single exact match, use it directly
                    if (result.Data.Count == 1)
                    {
                        _foundProduct = result.Data[0];
                    }
                    else
                    {
                        // Multiple matches - could show picker, for now take first
                        _foundProduct = result.Data[0];
                    }
                }
            }

            // If found locally, load stock entries
            if (_foundProduct != null)
            {
                await LoadStockEntriesAsync(_foundProduct.Id);
                return;
            }

            // Step 2: Not found locally - use product lookup plugins
            var lookupRequest = new ProductLookupRequest { Query = query, MaxResults = 10 };
            var lookupResult = await ApiClient.PostAsync<ProductLookupRequest, List<ProductLookupResult>>(
                "api/v1/products/lookup", lookupRequest);

            if (lookupResult.IsSuccess && lookupResult.Data?.Count > 0)
            {
                _lookupResults = lookupResult.Data;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{L["errors.generic"]}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSearching = false;
        }
    }

    private async Task LoadStockEntriesAsync(Guid productId)
    {
        if (!_selectedLocationId.HasValue) return;

        var result = await ApiClient.GetAsync<List<StockEntryDto>>(
            $"api/v1/stock/by-product/{productId}/location/{_selectedLocationId.Value}");

        if (result.IsSuccess && result.Data != null)
        {
            _stockEntries = result.Data.OrderBy(s => s.BestBeforeDate).ThenBy(s => s.PurchasedDate).ToList();
        }
    }

    private async Task SelectLookupResult(ProductLookupResult result)
    {
        // Show dialog to create product from lookup result
        var parameters = new DialogParameters<CreateProductFromLookupDialog>
        {
            { x => x.LookupResult, result },
            { x => x.DefaultLocationId, _selectedLocationId }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<CreateProductFromLookupDialog>(
            L["inventory.createProduct"], parameters, options);
        var dialogResult = await dialog.Result;

        if (dialogResult != null && !dialogResult.Canceled && dialogResult.Data is ProductDto newProduct)
        {
            // Product created successfully - now show add stock dialog
            _foundProduct = newProduct;
            _lookupResults.Clear();
            _stockEntries.Clear();
            StateHasChanged();

            // Automatically open the add stock dialog
            await ShowAddStockDialog();
        }
    }

    private void NavigateToCreateProduct()
    {
        var url = $"/products/new";
        if (IsBarcode(_searchQuery))
        {
            url += $"?barcode={Uri.EscapeDataString(_searchQuery)}";
        }
        NavigationManager.NavigateTo(url);
    }

    private async Task ShowAddStockDialog()
    {
        if (_foundProduct == null || !_selectedLocationId.HasValue) return;

        var parameters = new DialogParameters<AddStockDialog>
        {
            { x => x.Product, _foundProduct },
            { x => x.LocationId, _selectedLocationId.Value }
        };

        var dialog = await DialogService.ShowAsync<AddStockDialog>(L["inventory.addStock"], parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is AddStockRequest request)
        {
            var apiResult = await ApiClient.PostAsync<AddStockRequest, StockEntryDto>("api/v1/stock", request);
            if (apiResult.IsSuccess)
            {
                Snackbar.Add(L["inventory.stockAdded"], Severity.Success);
                await LoadStockEntriesAsync(_foundProduct.Id);
            }
            else
            {
                Snackbar.Add(apiResult.ErrorMessage ?? L["errors.generic"], Severity.Error);
            }
        }
    }

    private async Task ShowOpenDialog(StockEntryDto entry)
    {
        var parameters = new DialogParameters<OpenProductDialog>
        {
            { x => x.Entry, entry }
        };

        var dialog = await DialogService.ShowAsync<OpenProductDialog>(L["inventory.markOpen"], parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is OpenProductRequest request)
        {
            var apiResult = await ApiClient.PostAsync<OpenProductRequest, StockEntryDto>(
                $"api/v1/stock/{entry.Id}/open", request);
            if (apiResult.IsSuccess)
            {
                Snackbar.Add(L["inventory.productOpened"], Severity.Success);
                await LoadStockEntriesAsync(entry.ProductId);
            }
            else
            {
                Snackbar.Add(apiResult.ErrorMessage ?? L["errors.generic"], Severity.Error);
            }
        }
    }

    private async Task ShowAdjustDialog(StockEntryDto entry)
    {
        var parameters = new DialogParameters<AdjustStockDialog>
        {
            { x => x.Entry, entry }
        };

        var dialog = await DialogService.ShowAsync<AdjustStockDialog>(L["inventory.adjustQuantity"], parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is AdjustStockRequest request)
        {
            var apiResult = await ApiClient.PutAsync<AdjustStockRequest, StockEntryDto>(
                $"api/v1/stock/{entry.Id}", request);
            if (apiResult.IsSuccess)
            {
                Snackbar.Add(L["inventory.stockAdjusted"], Severity.Success);
                await LoadStockEntriesAsync(entry.ProductId);
            }
            else
            {
                Snackbar.Add(apiResult.ErrorMessage ?? L["errors.generic"], Severity.Error);
            }
        }
    }

    private async Task ShowConsumeDialog(StockEntryDto entry)
    {
        var parameters = new DialogParameters<ConsumeStockDialog>
        {
            { x => x.Entry, entry }
        };

        var dialog = await DialogService.ShowAsync<ConsumeStockDialog>(L["inventory.consume"], parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is ConsumeStockRequest request)
        {
            var apiResult = await ApiClient.PostAsync<ConsumeStockRequest>(
                $"api/v1/stock/{entry.Id}/consume", request);
            if (apiResult.IsSuccess)
            {
                Snackbar.Add(L["inventory.stockConsumed"], Severity.Success);
                await LoadStockEntriesAsync(entry.ProductId);
            }
            else
            {
                Snackbar.Add(apiResult.ErrorMessage ?? L["errors.generic"], Severity.Error);
            }
        }
    }

    private static ProductImageDto? GetPrimaryImage(ProductDto product)
    {
        return product.Images?.FirstOrDefault(i => i.IsPrimary)
            ?? product.Images?.FirstOrDefault();
    }

    private static bool IsBarcode(string input)
    {
        if (string.IsNullOrWhiteSpace(input)) return false;
        var cleaned = input.Trim().Replace("-", "").Replace(" ", "");
        return System.Text.RegularExpressions.Regex.IsMatch(cleaned, @"^[0-9]{8,14}$");
    }
}
