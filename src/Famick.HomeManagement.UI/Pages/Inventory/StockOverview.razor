@page "/stock"
@attribute [Authorize]
@using Famick.HomeManagement.Core.DTOs.Stock
@using Famick.HomeManagement.UI.Services
@using Famick.HomeManagement.UI.Components.Inventory
@inject IApiClient ApiClient
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ILocalizer L

<PageTitle>@L["stock.overview"] - Home Management</PageTitle>

@* Header Section *@
<MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
    <MudStack Row="true" AlignItems="AlignItems.Baseline" Spacing="2">
        <MudText Typo="Typo.h4">@L["stock.overview"]</MudText>
        @if (_statistics != null)
        {
            <MudText Typo="Typo.h6" Color="Color.Secondary">
                @_statistics.TotalProductCount @L["stock.products"], @_statistics.TotalStockValue.ToString("C") @L["stock.totalValue"]
            </MudText>
        }
    </MudStack>
    <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.History"
               OnClick="ShowJournalDialog">
        @L["stock.journal"]
    </MudButton>
</MudStack>

@* Status Badges Row *@
@if (_statistics != null)
{
    <MudStack Row="true" Spacing="2" Class="mb-4" Wrap="Wrap.Wrap">
        <MudChip T="string" Color="Color.Error" Variant="@(_currentStatus == "expired" ? Variant.Filled : Variant.Outlined)"
                 OnClick="@(() => ToggleStatusFilter("expired"))" Style="cursor: pointer">
            @_statistics.ExpiredCount @L["stock.expired"]
        </MudChip>
        <MudChip T="string" Color="Color.Default" Variant="@(_currentStatus == "overdue" ? Variant.Filled : Variant.Outlined)"
                 OnClick="@(() => ToggleStatusFilter("overdue"))" Style="cursor: pointer">
            @_statistics.OverdueCount @L["stock.overdue"]
        </MudChip>
        <MudChip T="string" Color="Color.Warning" Variant="@(_currentStatus == "dueSoon" ? Variant.Filled : Variant.Outlined)"
                 OnClick="@(() => ToggleStatusFilter("dueSoon"))" Style="cursor: pointer">
            @_statistics.DueSoonCount @L["stock.dueSoon"]
        </MudChip>
        <MudChip T="string" Color="Color.Success" Variant="@(_currentStatus == "belowMinStock" ? Variant.Filled : Variant.Outlined)"
                 OnClick="@(() => ToggleStatusFilter("belowMinStock"))" Style="cursor: pointer">
            @_statistics.BelowMinStockCount @L["stock.belowMinStock"]
        </MudChip>
    </MudStack>
}

@* Filter Row *@
<MudStack Row="true" Spacing="2" Class="mb-4" AlignItems="AlignItems.Center">
    <MudTextField T="string" @bind-Value="_searchTerm" Placeholder="@L["common.search"]"
                  Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                  Variant="Variant.Outlined" Margin="Margin.Dense" Immediate="true"
                  DebounceInterval="300" OnDebounceIntervalElapsed="OnSearchChanged"
                  Style="max-width: 300px;" />

    <LocationSelector @bind-SelectedLocationId="_selectedLocationId" LocationChanged="OnLocationChanged" />

    <ProductGroupSelector @bind-SelectedProductGroupId="_selectedProductGroupId" ProductGroupChanged="OnProductGroupChanged" />

    <MudSelect T="string" @bind-Value="_currentStatus" Label="@L["stock.filterStatus"]"
               Variant="Variant.Outlined" Margin="Margin.Dense" Dense="true"
               AnchorOrigin="Origin.BottomCenter" Style="min-width: 150px;">
        <MudSelectItem T="string" Value="@((string?)null)">@L["common.all"]</MudSelectItem>
        <MudSelectItem T="string" Value="@("expired")">@L["stock.statusExpired"]</MudSelectItem>
        <MudSelectItem T="string" Value="@("dueSoon")">@L["stock.statusDueSoon"]</MudSelectItem>
        <MudSelectItem T="string" Value="@("belowMinStock")">@L["stock.statusBelowMin"]</MudSelectItem>
    </MudSelect>
</MudStack>

@* Loading State *@
@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
}

@* Data Table *@
@if (_items.Count > 0)
{
    <MudDataGrid T="StockOverviewItemDto" Items="@_items" Dense="true" Hover="true"
                 SortMode="SortMode.Single" Filterable="false">
        <Columns>
            <TemplateColumn T="StockOverviewItemDto" Title="" Sortable="false" CellStyle="width: 140px;">
                <CellTemplate>
                    <MudStack Row="true" Spacing="1">
                        <MudTooltip Text="@L["stock.consumeOne"]">
                            <MudIconButton Icon="@Icons.Material.Filled.RemoveCircle" Size="Size.Small"
                                           Color="Color.Error"
                                           OnClick="@(() => QuickConsume(context.Item, 1))"
                                           Disabled="@(context.Item.TotalAmount < 1)" />
                        </MudTooltip>
                        <MudTooltip Text="@L["stock.consumeAll"]">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small"
                                           Color="Color.Error"
                                           OnClick="@(() => QuickConsumeAll(context.Item))"
                                           Disabled="@(context.Item.TotalAmount <= 0)" />
                        </MudTooltip>
                        <MudTooltip Text="@L["stock.addOne"]">
                            <MudIconButton Icon="@Icons.Material.Filled.AddCircle" Size="Size.Small"
                                           Color="Color.Success"
                                           OnClick="@(() => QuickAdd(context.Item))" />
                        </MudTooltip>
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="x => x.ProductName" Title="@L["stock.product"]" Sortable="true">
                <CellTemplate>
                    <MudStack Spacing="0">
                        <MudText>@context.Item.ProductName</MudText>
                        @if (!string.IsNullOrEmpty(context.Item.ProductGroupName))
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Item.ProductGroupName</MudText>
                        }
                    </MudStack>
                </CellTemplate>
            </PropertyColumn>
            <TemplateColumn T="StockOverviewItemDto" Title="@L["stock.amount"]" Sortable="true" SortBy="x => x.TotalAmount">
                <CellTemplate>
                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                        <MudText>@context.Item.TotalAmount.ToString("0.##")</MudText>
                        <MudText Color="Color.Secondary">@context.Item.QuantityUnitName</MudText>
                        @if (context.Item.IsBelowMinStock)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Warning">
                                (min: @context.Item.MinStockAmount.ToString("0.##"))
                            </MudText>
                        }
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn T="StockOverviewItemDto" Title="@L["stock.nextDueDate"]" Sortable="true" SortBy="x => x.NextDueDate">
                <CellTemplate>
                    @if (context.Item.NextDueDate.HasValue)
                    {
                        <MudStack Spacing="0">
                            <MudText Color="@GetDueDateColor(context.Item)">
                                @context.Item.NextDueDate.Value.ToString("yyyy-MM-dd")
                            </MudText>
                            <MudText Typo="Typo.caption" Color="@GetDueDateColor(context.Item)">
                                @GetRelativeTime(context.Item.DaysUntilDue)
                            </MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudText Color="Color.Secondary">@L["common.unknown"]</MudText>
                    }
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
}
else if (!_isLoading)
{
    <MudAlert Severity="Severity.Info" Class="mt-4">@L["stock.noItems"]</MudAlert>
}

@code {
    private StockStatisticsDto? _statistics;
    private List<StockOverviewItemDto> _items = new();
    private bool _isLoading = true;

    private string? _searchTerm;
    private Guid? _selectedLocationId;
    private Guid? _selectedProductGroupId;
    private string? _currentStatus;

    protected override async Task OnInitializedAsync()
    {
        // Check for status filter in URL
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        _currentStatus = query["status"];

        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            // Load statistics
            var statsResult = await ApiClient.GetAsync<StockStatisticsDto>("api/v1/stock/statistics");
            if (statsResult.IsSuccess)
            {
                _statistics = statsResult.Data;
            }

            // Load overview items with filters
            var filter = new StockOverviewFilterRequest
            {
                LocationId = _selectedLocationId,
                ProductGroupId = _selectedProductGroupId,
                Status = _currentStatus,
                SearchTerm = _searchTerm
            };

            var queryString = BuildQueryString(filter);
            var itemsResult = await ApiClient.GetAsync<List<StockOverviewItemDto>>($"api/v1/stock/overview{queryString}");
            if (itemsResult.IsSuccess && itemsResult.Data != null)
            {
                _items = itemsResult.Data;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string BuildQueryString(StockOverviewFilterRequest filter)
    {
        var parts = new List<string>();
        if (filter.LocationId.HasValue)
            parts.Add($"locationId={filter.LocationId}");
        if (filter.ProductGroupId.HasValue)
            parts.Add($"productGroupId={filter.ProductGroupId}");
        if (!string.IsNullOrEmpty(filter.Status))
            parts.Add($"status={filter.Status}");
        if (!string.IsNullOrEmpty(filter.SearchTerm))
            parts.Add($"searchTerm={Uri.EscapeDataString(filter.SearchTerm)}");

        return parts.Count > 0 ? "?" + string.Join("&", parts) : "";
    }

    private async Task OnSearchChanged(string? value)
    {
        _searchTerm = value;
        await LoadDataAsync();
    }

    private async Task OnLocationChanged(Core.DTOs.Locations.LocationDto? location)
    {
        await LoadDataAsync();
    }

    private async Task OnProductGroupChanged(Core.DTOs.ProductGroups.ProductGroupDto? group)
    {
        await LoadDataAsync();
    }

    private async Task ToggleStatusFilter(string status)
    {
        _currentStatus = _currentStatus == status ? null : status;
        await LoadDataAsync();
    }

    private async Task QuickConsume(StockOverviewItemDto item, decimal amount)
    {
        try
        {
            var request = new QuickConsumeRequest
            {
                ProductId = item.ProductId,
                Amount = amount,
                ConsumeAll = false
            };

            var result = await ApiClient.PostAsync<QuickConsumeRequest>("api/v1/stock/quick-consume", request);
            if (result.IsSuccess)
            {
                Snackbar.Add($"Consumed {amount} {item.QuantityUnitName} of {item.ProductName}", Severity.Success);
                await LoadDataAsync();
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? "Failed to consume", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task QuickConsumeAll(StockOverviewItemDto item)
    {
        try
        {
            var request = new QuickConsumeRequest
            {
                ProductId = item.ProductId,
                ConsumeAll = true
            };

            var result = await ApiClient.PostAsync<QuickConsumeRequest>("api/v1/stock/quick-consume", request);
            if (result.IsSuccess)
            {
                Snackbar.Add($"Consumed all {item.ProductName}", Severity.Success);
                await LoadDataAsync();
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? "Failed to consume", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task QuickAdd(StockOverviewItemDto item)
    {
        try
        {
            var result = await ApiClient.PostAsync<object>($"api/v1/stock/quick-add/{item.ProductId}?amount=1", new { });
            if (result.IsSuccess)
            {
                Snackbar.Add($"Added 1 {item.QuantityUnitName} of {item.ProductName}", Severity.Success);
                await LoadDataAsync();
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? "Failed to add", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task ShowJournalDialog()
    {
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        await DialogService.ShowAsync<StockJournalDialog>(L["stock.journal"], options);
    }

    private Color GetDueDateColor(StockOverviewItemDto item)
    {
        if (item.IsExpired) return Color.Error;
        if (item.IsDueSoon) return Color.Warning;
        return Color.Default;
    }

    private string GetRelativeTime(int? daysUntilDue)
    {
        if (!daysUntilDue.HasValue) return "";

        var days = daysUntilDue.Value;
        if (days < -365) return $"{Math.Abs(days / 365)} year(s) ago";
        if (days < -30) return $"{Math.Abs(days / 30)} month(s) ago";
        if (days < 0) return $"{Math.Abs(days)} day(s) ago";
        if (days == 0) return "today";
        if (days == 1) return "tomorrow";
        if (days < 30) return $"in {days} days";
        if (days < 365) return $"in {days / 30} month(s)";
        return $"in {days / 365} year(s)";
    }
}
