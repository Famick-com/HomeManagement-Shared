@page "/settings"
@attribute [Authorize]
@inject ILocalizer L
@inject NavigationManager Navigation
@inject HttpClient Http

<PageTitle>@L["nav.settings"]</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">@L["nav.settings"]</MudText>

@* Admin section *@
<AuthorizeView Policy="RequireAdmin">
    <Authorized>
        @* Mobile App Setup - Admin only, and only if enabled *@
        @if (_mobileAppSetupEnabled)
        {
            <MudText Typo="Typo.h5" Class="mb-3">@L["settings.mobileAppSetup.title"]</MudText>
            <div class="mb-6">
                <MudCard Outlined="true" Class="cursor-pointer" @onclick="@(() => Navigation.NavigateTo("/settings/mobile-setup"))">
                    <MudCardContent>
                        <div class="d-flex align-center gap-4">
                            <MudIcon Icon="@Icons.Material.Filled.QrCode2" Size="Size.Large" Color="Color.Primary" />
                            <div>
                                <MudText Typo="Typo.subtitle1">@L["settings.mobileAppSetup.title"]</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    @L["settings.mobileAppSetup.description"]
                                </MudText>
                            </div>
                            <MudSpacer />
                            <MudIcon Icon="@Icons.Material.Filled.ChevronRight" />
                        </div>
                    </MudCardContent>
                </MudCard>
            </div>
        }

        @* Users section - Admin only *@
        <MudText Typo="Typo.h5" Class="mb-3">@L["nav.users"]</MudText>
        <div class="mb-6">
            <UsersSection />
        </div>
    </Authorized>
</AuthorizeView>

@* Home Setup section *@
<MudText Typo="Typo.h5" Class="mb-3">@L["settings.homeSetup.title"]</MudText>
<div class="mb-6">
    <MudCard Outlined="true" Class="cursor-pointer" @onclick="@(() => Navigation.NavigateTo("/home-setup"))">
        <MudCardContent>
            <div class="d-flex align-center gap-4">
                <MudIcon Icon="@Icons.Material.Filled.HomeRepairService" Size="Size.Large" Color="Color.Primary" />
                <div>
                    <MudText Typo="Typo.subtitle1">@L["settings.homeSetup.rerun"]</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @L["settings.homeSetup.rerunDescription"]
                    </MudText>
                </div>
                <MudSpacer />
                <MudIcon Icon="@Icons.Material.Filled.ChevronRight" />
            </div>
        </MudCardContent>
    </MudCard>
</div>

@* Calendar section *@
<MudText Typo="Typo.h5" Class="mb-3">@L["calendar.settings.title"]</MudText>
<div class="mb-6">
    <Famick.HomeManagement.UI.Components.Calendar.ExternalCalendarManager />
</div>
<div class="mb-6">
    <Famick.HomeManagement.UI.Components.Calendar.IcsTokenManager />
</div>

@* Notification Preferences section *@
<MudText Typo="Typo.h5" Class="mb-3">@L["notifications.preferences.title"]</MudText>
<div class="mb-6">
    <NotificationPreferencesEditor />
</div>

@* Store Integrations section *@
<MudText Typo="Typo.h5" Class="mb-3">@L["nav.storeIntegrations"]</MudText>
<div class="mb-6">
    <StoreIntegrationsSection />
</div>

@* Quantity Units section *@
<MudText Typo="Typo.h5" Class="mb-3">@L["nav.quantityUnits"]</MudText>
<div class="mb-6">
    <QuantityUnitsSection />
</div>

@* Data Sources section *@
<MudText Typo="Typo.h5" Class="mb-3">@L["settings.dataSources.title"]</MudText>
<div class="mb-6">
    <DataSourcesSection />
</div>

@code {
    private bool _mobileAppSetupEnabled = false;

    protected override async Task OnInitializedAsync()
    {
        // Check if mobile app setup is enabled (for self-hosted servers)
        try
        {
            var response = await Http.GetFromJsonAsync<MobileAppConfigResponse>("api/setup/mobile-app/config");
            _mobileAppSetupEnabled = response?.IsEnabled ?? false;
        }
        catch
        {
            // If we can't fetch the config, assume it's disabled
            _mobileAppSetupEnabled = false;
        }
    }

    private record MobileAppConfigResponse(bool IsEnabled, bool IsConfigured);
}
