@page "/products"
@attribute [Authorize]
@inject IApiClient ApiClient
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ILocalizer L
@using Famick.HomeManagement.UI.Components.Products
@using Famick.HomeManagement.Core.DTOs.Products

<MudText Typo="Typo.h4" Class="mb-4">@L["products.title"]</MudText>

<MudPaper Elevation="1" Class="pa-4">
    @* Desktop toolbar *@
    <MudHidden Breakpoint="Breakpoint.SmAndDown">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3" Class="mb-4">
            <MudTextField @bind-Value="_searchText"
                          Placeholder="@L["products.searchProducts"]"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true"
                          DebounceInterval="300"
                          OnDebounceIntervalElapsed="OnSearchChanged"
                          Style="max-width: 300px;" />

            <MudSelect T="string" @bind-Value="_statusFilter"
                       Label="@L["products.filterByStatus"]"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       Style="max-width: 180px;">
                <MudSelectItem Value="@("all")">@L["products.allProducts"]</MudSelectItem>
                <MudSelectItem Value="@("active")">@L["products.activeOnly"]</MudSelectItem>
                <MudSelectItem Value="@("inactive")">@L["products.inactiveOnly"]</MudSelectItem>
            </MudSelect>

            <MudSpacer />

            <MudTooltip Text="@(CanEdit ? null : L["common.viewerNoPermission"])" Disabled="@CanEdit">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="NavigateToNewProduct"
                           Disabled="@(!CanEdit)">
                    @L["products.addProduct"]
                </MudButton>
            </MudTooltip>
        </MudStack>
    </MudHidden>

    @* Mobile toolbar *@
    <MudHidden Breakpoint="Breakpoint.MdAndUp">
        <MudStack Spacing="2" Class="mb-3">
            <MudStack Row="true" Spacing="2">
                <MudTextField @bind-Value="_searchText"
                              Placeholder="@L["products.searchProducts"]"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Immediate="true"
                              DebounceInterval="300"
                              OnDebounceIntervalElapsed="OnSearchChanged"
                              FullWidth="true" />
                <MudTooltip Text="@(CanEdit ? null : L["common.viewerNoPermission"])" Disabled="@CanEdit">
                    <MudIconButton Icon="@Icons.Material.Filled.Add"
                                   Color="Color.Primary"
                                   Variant="Variant.Filled"
                                   OnClick="NavigateToNewProduct"
                                   Disabled="@(!CanEdit)" />
                </MudTooltip>
            </MudStack>
            <MudSelect T="string" @bind-Value="_statusFilter"
                       Label="@L["products.filterByStatus"]"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       FullWidth="true">
                <MudSelectItem Value="@("all")">@L["products.allProducts"]</MudSelectItem>
                <MudSelectItem Value="@("active")">@L["products.activeOnly"]</MudSelectItem>
                <MudSelectItem Value="@("inactive")">@L["products.inactiveOnly"]</MudSelectItem>
            </MudSelect>
        </MudStack>
    </MudHidden>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    else if (_products.Count == 0)
    {
        <MudAlert Severity="Severity.Info">@L["products.noProducts"]</MudAlert>
    }
    else
    {
        @* Desktop: Full DataGrid *@
        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <MudDataGrid T="ProductDto"
                         Items="@_filteredProducts"
                         SortMode="SortMode.Single"
                         Filterable="false"
                         Hideable="false"
                         RowClick="OnRowClick"
                         Dense="true"
                         Hover="true"
                         Class="cursor-pointer">
                <Columns>
                    <HierarchyColumn T="ProductDto" />
                    <TemplateColumn Title="" Sortable="false" Filterable="false" Style="width: 50px;">
                        <CellTemplate>
                            @{
                                var primaryImage = context.Item.Images?.FirstOrDefault(i => i.IsPrimary)
                                    ?? context.Item.Images?.FirstOrDefault();
                            }
                            @if (primaryImage != null && !string.IsNullOrEmpty(primaryImage.ThumbnailDisplayUrl))
                            {
                                <MudImage Src="@primaryImage.ThumbnailDisplayUrl"
                                          Width="40" Height="40"
                                          ObjectFit="ObjectFit.Cover"
                                          Class="rounded"
                                          Alt="@context.Item.Name" />
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Outlined.Inventory2"
                                         Size="Size.Medium"
                                         Color="Color.Default"
                                         Style="opacity: 0.3;" />
                            }
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.Name" Title="@L["products.name"]" />
                    <TemplateColumn Title="@L["stock.inStock"]" Sortable="true" SortBy="@(new Func<ProductDto, object>(x => x.TotalStockAmount))">
                        <CellTemplate>
                            @if (context.Item.TotalStockAmount > 0)
                            {
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2">
                                        @context.Item.TotalStockAmount.ToString("0.##") @context.Item.QuantityUnitStockName
                                    </MudText>
                                    @if (context.Item.StockByLocation.Count > 1)
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @string.Join(", ", context.Item.StockByLocation.Select(s => $"{s.LocationName}: {s.Amount:0.##}"))
                                        </MudText>
                                    }
                                    else if (context.Item.StockByLocation.Count == 1)
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @context.Item.StockByLocation[0].LocationName
                                        </MudText>
                                    }
                                </MudStack>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Warning">@L["stock.outOfStock"]</MudText>
                            }
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.MinStockAmount" Title="@L["products.minStock"]" />
                    <TemplateColumn Title="@L["products.status"]">
                        <CellTemplate>
                            @if (context.Item.IsBelowMinStock && context.Item.MinStockAmount > 0)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Filled">@L["stock.belowMinStock"]</MudChip>
                            }
                            else if (context.Item.IsActive)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">@L["products.active"]</MudChip>
                            }
                            else
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">@L["products.inactive"]</MudChip>
                            }
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
                <ChildRowContent>
                    <MudCard Elevation="0" Class="pa-4 ma-2" Style="background-color: var(--mud-palette-background-grey);">
                        <MudCardContent>
                            <MudText Typo="Typo.subtitle2" Class="mb-2">@L["products.barcodes"]</MudText>
                            <ProductBarcodeList ProductId="@context.Item.Id"
                                                Barcodes="@context.Item.Barcodes"
                                                OnBarcodeAdded="@(barcode => HandleBarcodeAdded(context.Item, barcode))"
                                                OnBarcodeDeleted="@(barcode => HandleBarcodeDeleted(context.Item, barcode))" />
                        </MudCardContent>
                    </MudCard>
                </ChildRowContent>
                <PagerContent>
                    <MudDataGridPager T="ProductDto" />
                </PagerContent>
            </MudDataGrid>
        </MudHidden>

        @* Mobile: Compact list view *@
        <MudHidden Breakpoint="Breakpoint.MdAndUp">
            <MudList T="ProductDto" Dense="true" Class="pa-0">
                @foreach (var product in _filteredProducts)
                {
                    var primaryImage = product.Images?.FirstOrDefault(i => i.IsPrimary)
                        ?? product.Images?.FirstOrDefault();
                    <MudListItem T="ProductDto" OnClick="@(() => NavigateToProduct(product.Id))" Class="pa-2 rounded mb-1" Style="background: var(--mud-palette-surface);">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            @if (primaryImage != null && !string.IsNullOrEmpty(primaryImage.ThumbnailDisplayUrl))
                            {
                                <MudImage Src="@primaryImage.ThumbnailDisplayUrl"
                                          Width="48" Height="48"
                                          ObjectFit="ObjectFit.Cover"
                                          Class="rounded"
                                          Alt="@product.Name" />
                            }
                            else
                            {
                                <MudPaper Width="48px" Height="48px" Elevation="0" Class="d-flex align-center justify-center rounded" Style="background: var(--mud-palette-background-grey);">
                                    <MudIcon Icon="@Icons.Material.Outlined.Inventory2"
                                             Size="Size.Medium"
                                             Color="Color.Default"
                                             Style="opacity: 0.4;" />
                                </MudPaper>
                            }
                            <MudStack Spacing="0" Class="flex-grow-1 overflow-hidden">
                                <MudText Typo="Typo.body1" Class="text-truncate" Style="font-weight: 500;">@product.Name</MudText>
                                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                    @if (product.TotalStockAmount > 0)
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @product.TotalStockAmount.ToString("0.##") @product.QuantityUnitStockName
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Warning">@L["stock.outOfStock"]</MudText>
                                    }
                                    @if (product.IsBelowMinStock && product.MinStockAmount > 0)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Filled" Class="ma-0 pa-1">@L["stock.belowMinStock"]</MudChip>
                                    }
                                    else if (!product.IsActive)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined" Class="ma-0 pa-1">@L["products.inactive"]</MudChip>
                                    }
                                </MudStack>
                            </MudStack>
                            <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Color="Color.Default" />
                        </MudStack>
                    </MudListItem>
                }
            </MudList>
        </MudHidden>
    }
</MudPaper>

@code {
    [CascadingParameter(Name = "CanEdit")]
    private bool CanEdit { get; set; }

    private List<ProductDto> _products = new();
    private bool _isLoading = true;
    private string _searchText = string.Empty;
    private string _statusFilter = "all";

    private IEnumerable<ProductDto> _filteredProducts => _products
        .Where(p => string.IsNullOrEmpty(_searchText) ||
                    p.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                    p.Barcodes.Any(b => b.Barcode.Contains(_searchText, StringComparison.OrdinalIgnoreCase)))
        .Where(p => _statusFilter == "all" ||
                    (_statusFilter == "active" && p.IsActive) ||
                    (_statusFilter == "inactive" && !p.IsActive));

    protected override async Task OnInitializedAsync()
    {
        await LoadProductsAsync();
    }

    private async Task LoadProductsAsync()
    {
        _isLoading = true;

        try
        {
            var result = await ApiClient.GetAsync<List<ProductDto>>("api/v1/products");
            if (result.IsSuccess && result.Data != null)
            {
                _products = result.Data;
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? L["errors.generic"], Severity.Error);
            }
        }
        catch (Exception)
        {
            Snackbar.Add(L["errors.generic"], Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OnSearchChanged(string value)
    {
        _searchText = value;
        StateHasChanged();
    }

    private void NavigateToNewProduct()
    {
        Navigation.NavigateTo("/products/new");
    }

    private void OnRowClick(DataGridRowClickEventArgs<ProductDto> args)
    {
        Navigation.NavigateTo($"/products/{args.Item.Id}");
    }

    private void NavigateToProduct(Guid productId)
    {
        Navigation.NavigateTo($"/products/{productId}");
    }

    private async Task HandleBarcodeAdded(ProductDto product, ProductBarcodeDto barcode)
    {
        try
        {
            var result = await ApiClient.PostAsync<ProductBarcodeDto, ProductBarcodeDto>(
                $"api/v1/products/{product.Id}/barcodes?barcode={Uri.EscapeDataString(barcode.Barcode)}&note={Uri.EscapeDataString(barcode.Note ?? "")}",
                barcode);

            if (result.IsSuccess && result.Data != null)
            {
                product.Barcodes.Add(result.Data);
                Snackbar.Add(L["products.barcodeAdded"], Severity.Success);
                StateHasChanged();
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? L["errors.generic"], Severity.Error);
            }
        }
        catch (Exception)
        {
            Snackbar.Add(L["errors.generic"], Severity.Error);
        }
    }

    private async Task HandleBarcodeDeleted(ProductDto product, ProductBarcodeDto barcode)
    {
        var confirmed = await DialogService.ShowMessageBox(
            L["confirmations.deleteTitle"],
            L["products.confirmDeleteBarcode"],
            yesText: L["common.delete"],
            cancelText: L["common.cancel"]);

        if (confirmed != true) return;

        try
        {
            var result = await ApiClient.DeleteAsync($"api/v1/products/{product.Id}/barcodes/{barcode.Id}");

            if (result.IsSuccess)
            {
                product.Barcodes.Remove(barcode);
                Snackbar.Add(L["products.barcodeDeleted"], Severity.Success);
                StateHasChanged();
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? L["errors.generic"], Severity.Error);
            }
        }
        catch (Exception)
        {
            Snackbar.Add(L["errors.generic"], Severity.Error);
        }
    }
}
